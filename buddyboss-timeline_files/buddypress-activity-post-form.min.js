window.wp=window.wp||{},window.bp=window.bp||{},function(e,t){bp.Nouveau=bp.Nouveau||{},void 0!==bp.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",bp.draft_ajax_request=null,bp.old_draft_data=!1,bp.draft_activity={object:!1,data_key:!1,data:!1,post_action:"update",allow_delete_media:!1,display_post:""},bp.draft_local_interval=!1,bp.draft_ajax_interval=!1,bp.draft_content_changed=!1,bp.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new bp.Collections.ActivityObjects,this.buttons=new Backbone.Collection,_.isUndefined(window.Dropzone)||_.isUndefined(BP_Nouveau.media)||this.dropzoneView(),this.postFormView(),this.postFormPlaceholderView(),this.getCurrentDraftActivity(),this.syncDraftActivity(),this.reloadWindow()},postFormView:function(){if(this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),t("#bp-nouveau-activity-form").length){this.postForm=new bp.Views.PostForm,this.views.add({id:"post_form",view:this.postForm}),this.postForm.inject("#bp-nouveau-activity-form"),t(".activity-update-form #user-status-huddle, .activity-update-form #whats-new-content, .activity-update-form  #whats-new-attachments").wrapAll('<div class="whats-new-form-header"></div>');var e=this;t(document).on("click",".activity-update-form.modal-popup:not(.bp-activity-edit) .activity-update-form-overlay",function(){e.postForm.$el.hasClass("bp-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),setTimeout(function(){t(".activity-update-form.modal-popup #whats-new").blur(),t(".activity-update-form.modal-popup #aw-whats-new-reset").trigger("click");var e=t("#bp-nouveau-single-activity-edit-form-wrap");e.length&&e.hide()},0)}),Backbone.trigger("mediaprivacy")}},postFormPlaceholderView:function(){t("#bp-nouveau-activity-form-placeholder").length&&(this.postFormPlaceholder=new bp.Views.PostFormPlaceholder,this.views.add({id:"post_form_placeholder",view:this.postFormPlaceholder}),this.postFormPlaceholder.inject("#bp-nouveau-activity-form-placeholder"),t(".activity-form-placeholder #user-status-huddle, .activity-form-placeholder #whats-new-content-placeholder").wrapAll('<div class="whats-new-form-header"></div>'))},dropzoneView:function(){this.dropzone=null,window.Dropzone.autoDiscover=!1,this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation,maxThumbnailFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size},_.isUndefined(BP_Nouveau.media.dropzone_options)||Object.assign(this.dropzone_options,BP_Nouveau.media.dropzone_options)},displayEditActivity:function(e,t){bp.draft_activity.allow_delete_media=!0,bp.draft_activity.display_post="edit",this.postForm.$el.trigger("reset"),this.editActivityData=e,this.model.set("edit_activity",!0),this.postForm.$el.addClass("bp-activity-edit").addClass("loading"),this.postForm.$el.find(".bp-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),this.postForm.$el.removeClass("bp-hide"),this.postForm.$el.find("#whats-new-toolbar").addClass("hidden"),setTimeout(function(){var i=new Event("bp_activity_edit");bp.Nouveau.Activity.postForm.displayEditDraftActivityData(e,i,t)},0)},displayEditActivityForm:function(e,i){var o=t("#bp-nouveau-activity-form"),a=t("#bp-nouveau-activity-form-placeholder"),s=t("#bp-nouveau-single-activity-edit-form-wrap");s.length&&s.show(),bp.privacyEditable=e.can_edit_privacy,bp.album_id=e.album_id,bp.folder_id=e.folder_id,bp.group_id=e.group_id,bp.privacy=e.privacy,this.displayEditActivity(e,i),this.model.set("edit_activity",!0);var d=t("#whats-new")[0];window.activity_edit_editor&&"function"==typeof window.activity_edit_editor.destroy&&window.activity_edit_editor.destroy(),window.activity_edit_editor=new toastui.Editor({el:d,initialEditType:"wysiwyg",previewStyle:"tab",height:"auto",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder||"",initialValue:t(d).html(),toolbarItems:[["bold","italic"],["ul","ol"],["quote"],["link"],["codeblock"]],events:{},hooks:{paste:function(e){return setTimeout(function(){var e=window.activity_edit_editor.getEditorElements().wwEditor;if(e){var i=t(e).find("li").filter(function(){return!t(this).parent().is("ul")&&!t(this).parent().is("ol")});if(i.length>0){var o=t("<ul></ul>");i.first().before(o),o.append(i);var a=t(e).html();window.activity_edit_editor.setHTML(a)}}},0),e}}}),o.addClass("modal-popup").closest("body").addClass("activity-modal-open"),a.show(),setTimeout(function(){t("#whats-new img.emoji").each(function(e,i){t(i).addClass("emojioneemoji");var o=t(i).attr("alt");t(i).attr("data-emoji-char",o),t(i).removeClass("emoji")})},10),this.activityEditHideModalEvent()},activityEditHideModalEvent:function(){var e=this;t(document).on("keyup",function(e){27===e.keyCode&&!1===e.ctrlKey&&t(".activity-update-form.modal-popup.bp-activity-edit #aw-whats-new-reset").trigger("click")}),t(document).on("click",".activity-update-form.modal-popup.bp-activity-edit #aw-whats-new-reset",function(){e.postActivityEditHideModal()})},postActivityEditHideModal:function(){bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",t(".activity-update-form.modal-popup").removeClass("modal-popup group-activity").closest("body").removeClass("activity-modal-open");var e=t("#bp-nouveau-activity-form-placeholder"),i=t("#bp-nouveau-single-activity-edit-form-wrap"),o=t("#bp-nouveau-activity-form");t("#whats-new-content").parent().is(".edit-activity-content-wrap")&&t("#whats-new-content").unwrap(),e.hide(),i.length&&i.hide(),o.hasClass("is-bp-hide")&&o.addClass("bp-hide"),bp.Views.ActivityHeader.prototype.resetMultiMediaOptions()},createThumbnailFromUrl:function(e){var t=this;t.dropzone.createThumbnailFromUrl(e,t.dropzone.options.thumbnailWidth,t.dropzone.options.thumbnailHeight,t.dropzone.options.thumbnailMethod,!0,function(i){t.dropzone.emit("thumbnail",e,i),t.dropzone.emit("complete",e)})},displayEditDraftActivityData:function(e,i,o){if(this.postForm.$el.parent("#bp-nouveau-activity-form").removeClass("bp-hide"),window.activity_edit_editor)window.activity_edit_editor.setHTML(e.content||""),window.activity_edit_editor.focus();else if(window.activity_editor)window.activity_editor.setHTML(e.content||""),window.activity_editor.focus();else{this.postForm.$el.find("#whats-new").html(e.content);var a=this.postForm.$el.find("#whats-new").get(0);a&&a.focus()}if(null!=o&&this.postForm.$el.find("#whats-new").data("activity-url-preview",o),0<parseInt(e.id)?this.postForm.$el.find("#bp-activity-id").val(e.id):(e.gif=e.gif_data,e.group_name=e.item_name,e.group_avatar=e.group_image,"group"===e.object&&(e.object="groups")),this.postForm.model.set("link_image_index",e.link_image_index_save),this.postForm.model.set("link_image_index_save",e.link_image_index_save),void 0!==BP_Nouveau.activity_schedule&&BP_Nouveau.activity_schedule.strings.activity_schedule_enabled)if("scheduled"===e.activity_action_type||"scheduled"===e.status)if(this.postForm.model.set("activity_schedule_date_raw",e.activity_schedule_date_raw),this.postForm.model.set("activity_schedule_date",e.activity_schedule_date),this.postForm.model.set("activity_schedule_time",e.activity_schedule_time),this.postForm.model.set("activity_schedule_meridiem",e.activity_schedule_meridiem),"scheduled"===e.status)this.postForm.model.set("activity_action_type",e.status);else{this.postForm.model.set("activity_action_type",e.activity_action_type);var s=new Date(e.activity_schedule_date_raw+" "+e.activity_schedule_time+" "+e.activity_schedule_meridiem);new Date(bp.Nouveau.bbServerTime().currentServerTime)>s&&Backbone.trigger("onError",void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.scheduleWarning:"","warning")}else"published"===e.status&&this.postForm.$el.addClass("hide-schedule-button");if("group"===e.privacy||_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||t("#whats-new-form").find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),"group"===e.privacy||_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||t("#whats-new-form").find(".bb-post-poll-button").removeClass("bp-hide"),"group"===e.privacy){var d=t("#whats-new-form"),n=d.find("#bp-item-opt-"+e.item_id).data("allow-schedule-post");_.isUndefined(n)&&(_.isUndefined(e.schedule_allowed)||"enabled"!==e.schedule_allowed?_.isUndefined(e.schedule_allowed)||"disabled"!==e.schedule_allowed?_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||(n="enabled"):(n="disabled",this.postForm.model.set("schedule_allowed",e.schedule_allowed)):(n=e.schedule_allowed,this.postForm.model.set("schedule_allowed",e.schedule_allowed))),_.isUndefined(n)||"enabled"!==n?(this.postForm.model.set("activity_action_type",null),this.postForm.model.set("activity_schedule_date_raw",null),this.postForm.model.set("activity_schedule_date",null),this.postForm.model.set("activity_schedule_time",null),this.postForm.model.set("activity_schedule_meridiem",null),this.postForm.model.set("schedule_allowed","disabled"),d.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):d.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide");var l=d.find("#bp-item-opt-"+e.item_id).data("allow-polls");_.isUndefined(l)&&(_.isUndefined(e.polls_allowed)||"enabled"!==e.polls_allowed?_.isUndefined(e.polls_allowed)||"disabled"!==e.polls_allowed?_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||(l="enabled"):(l="disabled",this.postForm.model.set("polls_allowed",e.polls_allowed)):(l=e.polls_allowed,this.postForm.model.set("polls_allowed",e.polls_allowed))),_.isUndefined(l)||"enabled"!==l?d.find(".bb-post-poll-button").addClass("bp-hide"):d.find(".bb-post-poll-button").removeClass("bp-hide")}if(!_.isUndefined(e.poll)&&!t.isEmptyObject(e.poll)){var r={id:e.poll.id,user_id:parseInt(e.poll.user_id),item_id:_.isUndefined(e.poll.item_id)?0:e.poll.item_id,vote_disabled_date:e.poll.vote_disabled_date,question:e.poll.question,options:e.poll.options,allow_multiple_options:e.poll.allow_multiple_options||!1,allow_new_option:e.poll.allow_new_option||!1,duration:e.poll.duration||3,total_votes:e.poll.total_votes,edit_poll:e.edit_poll};this.postForm.model.set("poll",r),this.postForm.model.set("poll_id",e.poll.id)}var c=t(".activity-form.focus-in #whats-new-toolbar");if(_.isUndefined(this.activityToolbar)||(this.activityToolbar.closeGifSelector(i),this.activityToolbar.closeMediaSelector(i),this.activityToolbar.closeDocumentSelector(i),this.activityToolbar.closeVideoSelector(i)),!_.isUndefined(e.gif)&&Object.keys(e.gif).length&&(this.activityToolbar.toggleGifSelector(i),this.activityToolbar.gifMediaSearchDropdownView.model.set("gif_data",e.gif),c.find("#activity-media-button")&&c.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-document-button")&&c.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-video-button")&&c.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-gif-button")&&c.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("active")),!_.isUndefined(e.media)&&e.media.length){_.isUndefined(this.activityToolbar)||this.activityToolbar.toggleMediaSelector(i),c.find("#activity-media-button")&&c.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("active no-click"),c.find("#activity-document-button")&&c.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-video-button")&&c.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-gif-button")&&c.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable");for(var p=!1,u=0;u<e.media.length;u++){p=!1;var v={};v=0<parseInt(e.id)?{id:e.media[u].attachment_id,media_id:e.media[u].id,name:e.media[u].name,thumb:e.media[u].thumb,url:e.media[u].url,uuid:e.media[u].attachment_id,menu_order:e.media[u].menu_order,album_id:e.media[u].album_id,group_id:e.media[u].group_id,saved:!0}:{id:e.media[u].id,name:e.media[u].name,thumb:e.media[u].thumb,url:e.media[u].url,uuid:e.media[u].id,menu_order:e.media[u].menu_order,album_id:e.media[u].album_id,group_id:e.media[u].group_id,saved:!1},p={name:e.media[u].title,accepted:!0,kind:"image",upload:{filename:e.media[u].title,uuid:e.media[u].attachment_id},dataURL:e.media[u].url,id:e.media[u].attachment_id,media_edit_data:v},this.dropzone&&(this.dropzone.files.push(p),this.dropzone.emit("addedfile",p),(BP_Nouveau.is_as3cf_active,"1"===BP_Nouveau.is_as3cf_active)?(t(this.dropzone.files[u].previewElement).find("img").attr("src",e.media[u].thumb),this.dropzone.emit("thumbnail",e.media[u].thumb),this.dropzone.emit("complete",p)):this.createThumbnailFromUrl(p),this.dropzone.emit("dz-success"),this.dropzone.emit("dz-complete"))}}if(!_.isUndefined(e.document)&&e.document.length){_.isUndefined(this.activityToolbar)||this.activityToolbar.toggleDocumentSelector(i),c.find("#activity-media-button")&&c.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-video-button")&&c.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-document-button")&&c.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("active no-click"),c.find("#activity-gif-button")&&c.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable");for(var m=!1,h=0;h<e.document.length;h++){m=!1;var f={};f=0<parseInt(e.id)?{id:e.document[h].doc_id,name:e.document[h].full_name,full_name:e.document[h].full_name,type:"document",url:e.document[h].url,size:e.document[h].size,uuid:e.document[h].doc_id,document_id:e.document[h].id,menu_order:e.document[h].menu_order,folder_id:e.document[h].folder_id,group_id:e.document[h].group_id,saved:!0,svg_icon:_.isUndefined(e.document[h].svg_icon)?"":e.document[h].svg_icon}:{id:e.document[h].id,name:e.document[h].full_name,full_name:e.document[h].full_name,type:"document",url:e.document[h].url,size:e.document[h].size,uuid:e.document[h].id,menu_order:e.document[h].menu_order,folder_id:e.document[h].folder_id,group_id:e.document[h].group_id,saved:!1,svg_icon:_.isUndefined(e.document[h].svg_icon)?"":e.document[h].svg_icon},m={name:e.document[h].full_name,size:e.document[h].size,accepted:!0,kind:"file",upload:{filename:e.document[h].full_name,uuid:e.document[h].doc_id},dataURL:e.document[h].url,id:e.document[h].doc_id,document_edit_data:f,svg_icon:_.isUndefined(e.document[h].svg_icon)?"":e.document[h].svg_icon},this.dropzone&&(this.dropzone.files.push(m),this.dropzone.emit("addedfile",m),this.dropzone.emit("complete",m))}}if(!_.isUndefined(e.video)&&e.video.length){_.isUndefined(this.activityToolbar)||this.activityToolbar.toggleVideoSelector(i),this.postForm.$el.hasClass("has-draft")&&this.postForm.$el.addClass("media-uploading draft-video-uploading"),c.find("#activity-media-button")&&c.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-document-button")&&c.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),c.find("#activity-video-button")&&c.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("active no-click"),c.find("#activity-gif-button")&&c.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable");for(var b=!1,y=0;y<e.video.length;y++){b=!1;var w={};w=0<parseInt(e.id)?{id:e.video[y].vid_id,name:e.video[y].name,type:"video",thumb:e.video[y].thumb,url:e.video[y].url,size:e.video[y].size,uuid:e.video[y].vid_id,video_id:e.video[y].id,menu_order:e.video[y].menu_order,album_id:e.video[y].album_id,group_id:e.video[y].group_id,saved:!0}:{id:e.video[y].id,name:e.video[y].name,type:"video",thumb:e.video[y].thumb,url:e.video[y].url,size:e.video[y].size,uuid:e.video[y].id,menu_order:e.video[y].menu_order,album_id:e.video[y].album_id,group_id:e.video[y].group_id,saved:!1},b={name:e.video[y].name,size:e.video[y].size,accepted:!0,kind:"file",upload:{filename:e.video[y].name,uuid:e.video[y].vid_id},dataURL:e.video[y].url,id:e.video[y].vid_id,video_edit_data:w},this.dropzone&&(this.dropzone.files.push(b),this.dropzone.emit("addedfile",b),this.dropzone.emit("complete",b))}}this.postForm.$el.find("#whats-new").trigger("keyup"),this.postForm.$el.removeClass("loading");var g=this.postForm.$el.find("#"+e.privacy).data("title");this.postForm.$el.find("#bp-activity-privacy-point").removeClass().addClass(e.privacy),this.postForm.$el.find(".bp-activity-privacy-status").text(g),this.postForm.$el.find(".bp-activity-privacy__input#"+e.privacy).prop("checked",!0);var C=t('[data-bp-list="activity"] #activity-'+e.id).find("ul.activity-privacy li.selected").data("value"),N=t('[data-bp-list="activity"] #activity-'+e.id).find("ul.activity-privacy li.selected").text();_.isUndefined(C)||(this.postForm.$el.find("#bp-activity-privacy-point").removeClass().addClass(C),this.postForm.$el.find(".bp-activity-privacy-status").text(N),this.postForm.$el.find(".bp-activity-privacy__input#"+C).prop("checked",!0)),_.isUndefined(e)||(_.isUndefined(e.object)||_.isUndefined(e.item_id)||"groups"!==e.object?(_.isUndefined(e.profile_media)||!1!==e.profile_media?(t(".activity-media-container").css("pointer-events","auto"),t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide")):(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),t(".activity-media-container #activity-post-media-uploader .dz-default.dz-message").hide(),t(".activity-media-container").css("pointer-events","none")),_.isUndefined(e.profile_document)||!1!==e.profile_document?(t(".activity-document-container").css("pointer-events","auto"),t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide")):(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),t(".activity-document-container #activity-post-document-uploader .dz-default.dz-message").hide(),t(".activity-document-container").css("pointer-events","none")),_.isUndefined(e.profile_video)||!1!==e.profile_video?(t(".activity-video-container").css("pointer-events","auto"),t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide")):(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),t(".activity-video-container #activity-post-video-uploader .dz-default.dz-message").hide(),t(".activity-video-container").css("pointer-events","none")),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model})):(_.isUndefined(e.group_media)||!1!==e.group_media?t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"):(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),t(".edit-activity-content-wrap #whats-new-attachments .activity-media-container #activity-post-media-uploader .dz-default.dz-message").hide()),_.isUndefined(e.group_document)||!1!==e.group_document?t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"):(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),t(".edit-activity-content-wrap #whats-new-attachments .activity-document-container #activity-post-document-uploader .dz-default.dz-message").hide()),_.isUndefined(e.group_video)||!1!==e.group_video?t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"):(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),t(".edit-activity-content-wrap #whats-new-attachments .activity-video-container #activity-post-video-uploader .dz-default.dz-message").hide()),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}))),_.isUndefined(e.object)||_.isUndefined(e.item_id)||"groups"!==e.object||(this.postForm.model.set("item_id",e.item_id),this.postForm.model.set("object","group"),this.postForm.model.set("group_name",e.group_name),this.postForm.$el.find("input#group").prop("checked",!0),0<parseInt(e.id)||!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data?this.postForm.$el.find("#bp-activity-privacy-point").removeClass().addClass("group bp-activity-edit-group"):this.postForm.$el.find("#bp-activity-privacy-point").removeClass().addClass("group"),this.postForm.$el.find("#bp-activity-privacy-point").find("i.bb-icon-angle-down").remove(),this.postForm.$el.find(".bp-activity-privacy-status").text(e.group_name),e.group_avatar&&!1===e.group_avatar.includes("mystery-group")&&this.postForm.$el.find("#bp-activity-privacy-point span.privacy-point-icon").removeClass("privacy-point-icon").addClass("group-privacy-point-icon").html('<img src="'+e.group_avatar+'" alt=""/>')),bp.privacyEditable||"groups"===e.object?this.postForm.$el.removeClass("bp-activity-edit--privacy-idle"):this.postForm.$el.addClass("bp-activity-edit--privacy-idle"),0<parseInt(e.id)?Backbone.trigger("editactivity"):this.postForm.$el.removeClass("focus-in--empty loading")},getCurrentDraftActivity:function(){if(t("body").hasClass("activity")&&!_.isUndefined(BP_Nouveau.activity.params.object)){bp.draft_activity.object=BP_Nouveau.activity.params.object,bp.draft_activity.data_key="draft_"+BP_Nouveau.activity.params.object,"group"===BP_Nouveau.activity.params.object?bp.draft_activity.data_key="draft_"+BP_Nouveau.activity.params.object+"_"+BP_Nouveau.activity.params.item_id:0<BP_Nouveau.activity.params.displayed_user_id&&(bp.draft_activity.data_key="draft_"+BP_Nouveau.activity.params.object+"_"+BP_Nouveau.activity.params.displayed_user_id);var e=localStorage.getItem(bp.draft_activity.data_key);if(!_.isUndefined(e)&&null!==e&&0<e.length)if("deleted"!==t.cookie(bp.draft_activity.data_key)){var i=JSON.parse(e);bp.draft_activity.data=i.data}else t.removeCookie(bp.draft_activity.data_key)}return bp.draft_activity},isProfileDraftActivity:function(e){return!!_.isUndefined(e)||!!_.isUndefined(e.object)||!!_.isUndefined(e.item_id)||"groups"!==e.object},displayDraftActivity:function(){var e=bp.draft_activity.data,i=this;if(bp.draft_activity.allow_delete_media=!0,!(!e||t("#whats-new-form").hasClass("bp-activity-edit"))){var o=this.isProfileDraftActivity(e);e.profile_media=BP_Nouveau.media.profile_media,e.group_media=BP_Nouveau.media.group_media,!1===e.profile_media&&o?delete e.media:!1!==e.group_media||o||delete e.media,e.profile_document=BP_Nouveau.media.profile_document,e.group_document=BP_Nouveau.media.group_document,!1===e.profile_document&&o?delete e.document:!1!==e.group_document||o||delete e.document,e.profile_video=BP_Nouveau.video.profile_video,e.group_video=BP_Nouveau.video.group_video,!1===e.profile_video&&o?delete e.video:!1!==e.group_video||o||delete e.video,"group"===e.object&&void 0!==e.item_id&&t("#whats-new").attr("data-suggestions-group-id",e.item_id).data("suggestions-group-id",e.item_id),!1===BP_Nouveau.media.profile_media?(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.profile_document?(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.profile_video?(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),setTimeout(function(){if(t("body").hasClass("activity-modal-open")){i.postForm.$el.addClass("loading").addClass("has-draft");var o=new Event("bp_activity_edit");bp.Nouveau.Activity.postForm.displayEditDraftActivityData(e,o,e.link_url)}},0)}},syncDraftActivity:function(){bp.draft_activity.data&&""!==bp.draft_activity.data||_.isUndefined(BP_Nouveau.activity.params.draft_activity.data_key)||("deleted"===t.cookie(bp.draft_activity.data_key)?(bp.draft_activity.data=!1,BP_Nouveau.activity.params.draft_activity="",localStorage.removeItem(bp.draft_activity.data_key),t.removeCookie(bp.draft_activity.data_key)):(bp.old_draft_data=BP_Nouveau.activity.params.draft_activity.data,bp.draft_activity=BP_Nouveau.activity.params.draft_activity,bp.draft_activity.data=this.restoreVideoJsPreview(bp.draft_activity.data,bp.old_draft_data),this.checkAndStoreDraftToLocalStorage(bp.draft_activity)))},collectDraftActivity:function(){var e={};if(!(_.isUndefined(this.postForm)||this.postForm.$el.hasClass("bp-activity-edit"))){_.each(this.postForm.$el.serializeArray(),function(t){t.name=t.name.replace("[]",""),t.name.startsWith("bb-poll-question-option[")&&(t.name=t.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],t.name)&&(_.isUndefined(e[t.name])?e[t.name]=t.value:(_.isArray(e[t.name])||(e[t.name]=[e[t.name]]),e[t.name].push(t.value)))});var i="";if(window.activity_editor)i=window.activity_editor.getHTML();else if(window.activity_edit_editor)i=window.activity_edit_editor.getHTML();else{var o=this.postForm.$el.find("#whats-new")[0];o&&(i=t.trim(o.innerHTML))}i=i.replace(/&nbsp;/g," "),this.postForm.model.set("content",i,{silent:!0}),this.postForm.model.set(e,{silent:!0});var a=this.postForm.model.get("media");if("group"===this.postForm.model.get("object")&&!_.isUndefined(a)&&a.length){for(var s=0;s<a.length;s++)a[s].group_id=this.postForm.model.get("item_id");this.postForm.model.set("media",a)}else if(!_.isUndefined(a)&&a.length){for(var d=0;d<a.length;d++)delete a[d].group_id;this.postForm.model.set("media",a)}var n=this.postForm.model.get("document");if("group"===this.postForm.model.get("object")&&!_.isUndefined(n)&&n.length){for(var l=0;l<n.length;l++)n[l].group_id=this.postForm.model.get("item_id");this.postForm.model.set("document",n)}else if(!_.isUndefined(n)&&n.length){for(var r=0;r<n.length;r++)delete n[r].group_id;this.postForm.model.set("document",n)}var c=this.postForm.model.get("video");if("group"===this.postForm.model.get("object")&&!_.isUndefined(c)&&c.length){for(var p=0;p<c.length;p++)c[p].group_id=this.postForm.model.get("item_id");this.postForm.model.set("video",c)}else if(!_.isUndefined(c)&&c.length){for(var u=0;u<c.length;u++)delete c[u].group_id;this.postForm.model.set("video",c)}var v=t(t.parseHTML(i)).text().trim();if(i.includes("data-emoji-char")&&""===v&&(v=i),""===v&&(!_.isUndefined(this.postForm.model.get("video"))&&!this.postForm.model.get("video").length||_.isUndefined(this.postForm.model.get("video")))&&(!_.isUndefined(this.postForm.model.get("document"))&&!this.postForm.model.get("document").length||_.isUndefined(this.postForm.model.get("document")))&&(!_.isUndefined(this.postForm.model.get("media"))&&!this.postForm.model.get("media").length||_.isUndefined(this.postForm.model.get("media")))&&(!_.isUndefined(this.postForm.model.get("gif_data"))&&!Object.keys(this.postForm.model.get("gif_data")).length||_.isUndefined(this.postForm.model.get("media")))&&(!_.isUndefined(this.postForm.model.get("poll"))&&!t.isEmptyObject(this.postForm.model.get("poll"))&&!Object.keys(this.postForm.model.get("poll")).length||_.isUndefined(this.postForm.model.get("poll"))))return bp.draft_content_changed?(localStorage.removeItem(bp.draft_activity.data_key),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)):(bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key)),!1;var m={};if(m=_.omit(_.extend(m,this.postForm.model.attributes),["link_images","link_image_index","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting"]),void 0!==bp.draft_activity.data&&void 0!==bp.draft_activity.data.item_id&&0<bp.draft_activity.data.item_id&&"group"===m.privacy&&(0===parseInt(m.item_id)||parseInt(bp.draft_activity.data.item_id)===parseInt(m.item_id))&&(m.item_id=parseInt(bp.draft_activity.data.item_id),m.item_name=bp.draft_activity.data.item_name,m.group_image=bp.draft_activity.data.group_image,m["group-privacy"]="bp-item-opt-"+bp.draft_activity.data.item_id,this.postForm.model.set("item_id",parseInt(bp.draft_activity.data.item_id)),this.postForm.model.set("item_name",bp.draft_activity.data.item_name),this.postForm.model.set("group_image",bp.draft_activity.data.group_image),this.postForm.model.set("group-privacy","bp-item-opt-"+bp.draft_activity.data.item_id)),this.postForm.model.get("link_success")){var h=this.postForm.model.get("link_images"),f=this.postForm.model.get("link_image_index");h&&h.length&&(m=_.extend(m,{link_image:h[f]}))}else m=_.omit(m,["link_title","link_description","link_url"]);this.checkedActivityDataChanged(bp.old_draft_data,m);var b=bp.draft_activity.data;bp.draft_activity.data=m,bp.draft_activity.data=this.restoreVideoJsPreview(bp.draft_activity.data,b),this.checkAndStoreDraftToLocalStorage(bp.draft_activity)}},checkedActivityDataChanged:function(e,t){bp.draft_content_changed||_.each(["object","user_id","content","item_id","item_name","group_image","media","document","video","gif_data","privacy","privacy_modal","link_embed","link_description","link_image","link_title","link_url","activity_action_type","activity_schedule_date_raw","activity_schedule_date","activity_schedule_time","activity_schedule_meridiem","schedule_allowed","poll","poll_id","polls_allowed"],function(i){!_.isUndefined(e[i])&&_.isUndefined(t[i])?bp.draft_content_changed=!0:_.isUndefined(e[i])&&!_.isUndefined(t[i])&&(bp.draft_content_changed=!0),-1!==_.indexOf(["media","document","video","gif_data"],i)||_.isUndefined(e[i])||_.isUndefined(t[i])||("object"===i?-1!==_.indexOf(["groups","group"],t[i])&&-1!==_.indexOf(["groups","group"],e[i])||-1!==_.indexOf(["user"],t[i])&&-1!==_.indexOf(["user"],e[i])?bp.draft_content_changed=!1:bp.draft_content_changed=!0:"user_id"===i||"item_id"===i?parseInt(e[i])!==parseInt(t[i])&&(bp.draft_content_changed=!0):"link_embed"===i?JSON.parse(e[i])!==JSON.parse(t[i])&&(bp.draft_content_changed=!0):e[i]!==t[i]&&(bp.draft_content_changed=!0))})},storeDraftActivity:function(){!t("body").hasClass("activity-modal-open")||this.postForm.$el.hasClass("bp-activity-edit")||bp.Nouveau.Activity.postForm.collectDraftActivity()},postDraftActivity:function(e,t){if(!(_.isUndefined(this.postForm)||this.postForm.$el.hasClass("bp-activity-edit")||!e&&(_.isUndefined(bp.draft_activity)||!_.isUndefined(bp.draft_activity)&&(!bp.draft_activity.data||""===bp.draft_activity.data)))&&(e||bp.draft_content_changed)){if(t){let e=new FormData;e.append("_wpnonce_post_draft",BP_Nouveau.activity.params.post_draft_nonce),e.append("action","post_draft_activity"),e.append("draft_activity",JSON.stringify(bp.draft_activity)),navigator.sendBeacon(BP_Nouveau.ajaxurl,e)}else{bp.draft_ajax_request&&bp.draft_ajax_request.abort();var i={_wpnonce_post_draft:BP_Nouveau.activity.params.post_draft_nonce,draft_activity:bp.draft_activity};_.isUndefined(i.draft_activity)||_.isUndefined(i.draft_activity.data)||_.isUndefined(i.draft_activity.data.link_description)||_.isUndefined(i.draft_activity.data.link_embed)||!0!==i.draft_activity.data.link_embed||(i.draft_activity.data.link_description=""),bp.draft_ajax_request=bp.ajax.post("post_draft_activity",i).done(function(){}).fail(function(){})}bp.old_draft_data=bp.draft_activity.data,bp.draft_content_changed=!1}},resetDraftActivity:function(e){t.cookie(bp.draft_activity.data_key,"deleted"),bp.draft_activity.post_action="delete",e&&bp.Nouveau.Activity.postForm.postDraftActivity(!0,!0),bp.draft_activity.data=!1,localStorage.removeItem(bp.draft_activity.data_key),this.postForm.$el.removeClass("has-draft"),bp.draft_activity.post_action="update",bp.draft_activity.display_post="",_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||t("#whats-new-form").find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||t("#whats-new-form").find(".bb-post-poll-button").removeClass("bp-hide")},reloadWindow:function(){window.onbeforeunload=function(e){void 0!==e&&(bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!0))},window.unload=function(e){void 0!==e&&(bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!0))}},clearDraftInterval:function(){clearInterval(bp.draft_local_interval),bp.draft_local_interval=!1,clearInterval(bp.draft_ajax_interval),bp.draft_ajax_interval=!1},restoreVideoJsPreview:function(e,i){if(e&&e.video&&e.video.length&&i&&i.video&&i.video.length){for(var o=0;o<e.video.length;o++)for(var a=0;a<i.video.length;a++)if(e.video[o].id&&i.video[a].id&&e.video[o].id===i.video[a].id){i.video[a].js_preview&&(e.video[o].js_preview=i.video[a].js_preview);break}t("form.draft-video-uploading.media-uploading").removeClass("draft-video-uploading media-uploading")}return e},checkAndStoreDraftToLocalStorage:function(e){try{var t=JSON.stringify(e),i=new TextEncoder,o=i.encode(t).length/1048576;if((o=o.toFixed(2))>4&&e.data&&e.data.video&&e.data.video.length){var a=JSON.parse(t);if(a.data&&a.data.video)for(var s=0;s<a.data.video.length&&!(a.data.video[s].js_preview&&(a.data.video[s].js_preview=null,t=JSON.stringify(a),(o=(o=i.encode(t).length/1048576).toFixed(2))<=4));s++);localStorage.setItem(e.data_key,t)}else localStorage.setItem(e.data_key,t)}catch(e){console.error("Error checking draft data size",e)}}},bp.Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.onClose&&this.onClose()},_.isUndefined(bp.View)&&(bp.View=bp.Backbone.View.extend({inject:function(e){this.render(),t(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.Activity=Backbone.Model.extend({defaults:{id:0,user_id:0,item_id:0,item_name:"",object:"",content:"",posting:!1,link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",gif_data:{},privacy:"public",privacy_modal:"general",edit_activity:!1,group_image:"",link_image_index_save:"0"}}),bp.Models.GifResults=Backbone.Model.extend({defaults:{q:"",data:[]}}),bp.Models.GifData=Backbone.Model.extend({}),bp.Collections.GifDatas=Backbone.Collection.extend({model:bp.Models.GifData}),bp.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),bp.Models.fetchData=Backbone.Model.extend({}),bp.Collections.ActivityObjects=Backbone.Collection.extend({model:bp.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),bp.ajax.send(i)},parse:function(e){return _.isArray(e)||(e=[e]),e}}),bp.Collections.fetchCollection=Backbone.Collection.extend({model:bp.Models.fetchData,url:BP_Nouveau.ajaxurl}),bp.Views.ActivityHeader=bp.View.extend({tagName:"header",id:"activity-header",template:bp.template("activity-header"),className:"bb-model-header",events:{"click .bb-model-close-button":"close"},initialize:function(){this.listenTo(Backbone,"privacy:headerupdate",this.updateHeader),this.listenTo(Backbone,"editactivity",this.updateEditActivityHeader),this.model.on("change:privacy_modal",this.render,this),this.model.on("change:edit_activity",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},updateHeader:function(){this.model.set("privacy_modal","profile")},updateEditActivityHeader:function(){this.model.set("edit_activity",!0)},close:function(e){this.$el.parent().hasClass("bp-activity-edit")||(bp.Nouveau.Activity.postForm.clearDraftInterval(),bp.Nouveau.Activity.postForm.collectDraftActivity(),bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)),bp.privacyEditable=!0,bp.album_id=0,bp.folder_id=0,bp.group_id=0,bp.privacy="public",e.preventDefault(),t("body").removeClass("initial-post-form-open"),this.$el.parent().find("#aw-whats-new-reset").trigger("click"),this.model.set("privacy_modal","general"),navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&t("input").focus().blur(),this.$el.closest("#whats-new-form").removeClass("focus-in--blank-group"),this.$el.closest("#whats-new-form").removeClass("bp-activity-edit--privacy-idle"),t("#bp-nouveau-single-activity-edit-form-wrap").hide();var i=t("#bp-nouveau-activity-form");i.hasClass("is-bp-hide")&&i.addClass("bp-hide"),this.resetMultiMediaOptions()},resetMultiMediaOptions:function(){null!==window.activityMediaAction&&(t(".activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),t("#whats-new-form").removeClass("focus-in--attm")}}),bp.Views.activityFeedback=bp.View.extend({tagName:"div",id:"message-feedabck",template:bp.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),bp.Views.ActivityMedia=bp.View.extend({tagName:"div",className:"activity-media-container",template:bp.template("activity-media"),media:[],initialize:function(){this.model.set("media",this.media),this.listenTo(Backbone,"activity_media_toggle",this.toggle_media_uploader),this.listenTo(Backbone,"activity_media_close",this.destroy)},toggle_media_uploader:function(){this.$el.find("#activity-post-media-uploader").hasClass("open")?this.destroy():this.open_media_uploader()},destroy:function(){_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),this.$el.find("#activity-post-media-uploader").html("")),this.media=[],this.$el.find("#activity-post-media-uploader").removeClass("open").addClass("closed"),t("#whats-new-attachments").addClass("empty").closest("#whats-new-form").removeClass("focus-in--attm")},open_media_uploader:function(){var e=this;if(e.$el.find("#activity-post-media-uploader").hasClass("open"))return!1;e.destroy(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,dictDefaultMessage:BP_Nouveau.media.dropzone_media_message,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.media.maxFiles)?10:BP_Nouveau.media.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,thumbnailWidth:140,thumbnailHeight:140,dictMaxFilesExceeded:BP_Nouveau.media.media_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-default-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation,maxThumbnailFilesize:_.isUndefined(BP_Nouveau.media.max_upload_size)?2:BP_Nouveau.media.max_upload_size,dictInvalidFileType:bp_media_dropzone.dictInvalidFileType},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-media-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(t){t.media_edit_data&&(e.media.push(t.media_edit_data),e.model.set("media",e.media))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(i){e.$el.closest("#whats-new-form").addClass("media-uploading");var o=t(i.previewElement).find(".dz-progress-ring circle")[0],a=2*o.r.baseVal.value*Math.PI;o.style.strokeDasharray=a+" "+a,o.style.strokeDashoffset=a;var s=a-i.upload.progress.toFixed(0)/100*a;o.style.strokeDashoffset=s}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(t,i,o){o.append("action","media_upload"),o.append("_wpnonce",BP_Nouveau.nonces.media);var a=e.$el.parents("#whats-new-form");a.find("#activity-document-button")&&a.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-video-button")&&a.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-gif-button")&&a.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-media-button")&&a.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(i,o){if(o.data.id){bp.privacyEditable||(o.data.album_id=bp.album_id,o.data.group_id=bp.group_id,o.data.privacy=bp.privacy),i.id=o.data.id,o.data.uuid=i.upload.uuid,o.data.group_id=!(_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.group_id))&&BP_Nouveau.media.group_id,o.data.saved=!1,o.data.menu_order=t(i.previewElement).closest(".dropzone").find(i.previewElement).index()-1,e.media.push(o.data),e.model.set("media",e.media);var a=t(i.previewElement).find(".dz-image img")[0];if(!(a.complete&&0!==a.naturalHeight)){var s,d,n,l,r,c=BP_Nouveau.media.invalid_media_type;for(i.previewElement.classList.add("dz-error"),l=i.previewElement.querySelectorAll("[data-dz-errormessage]"),r=[],d=0,n=l.length;d<n;d++)s=l[d],r.push(s.textContent=c);return o.data.menu_order_error_count=t(i.previewElement).closest(".dropzone").find(".dz-preview.dz-error").length,e.media.length===o.data.menu_order_error_count&&e.model.unset("media"),r}}else Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_media_type+". "+o.data.feedback+"</div>"),this.removeFile(i);bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(i,o){i.accepted?_.isUndefined(o)||_.isUndefined(o.data)||_.isUndefined(o.data.feedback)?"error"==i.status&&i.xhr&&0==i.xhr.status&&t(i.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):t(i.previewElement).find(".dz-error-message span").text(o.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_media_type+". "+(o||"")+"</div>"),this.removeFile(i),e.$el.closest("#whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(i){if(!0===bp.draft_activity.allow_delete_media){if(e.media.length){for(var o in e.media)if(i.id===e.media[o].id)_.isUndefined(e.media[o].saved)||e.media[o].saved||bp.Nouveau.Media.removeAttachment(i.id),e.media.splice(o,1),e.model.set("media",e.media);else if("edit"!==bp.draft_activity.display_post&&i.media_edit_data){var a=i.media_edit_data.id;a===e.media[o].id&&(_.isUndefined(e.media[o].saved)||e.media[o].saved||bp.Nouveau.Media.removeAttachment(a),e.media.splice(o,1),e.model.set("media",e.media))}var s=e.$el.find(".dz-preview.dz-error").length;e.media.length===s&&e.model.unset("media")}if(!_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)&&0===bp.Nouveau.Activity.postForm.dropzone.files.length){e.$el.closest("#whats-new-form").removeClass("media-uploading");var d=e.$el.parents("#whats-new-form");d.find("#activity-document-button")&&d.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable no-click"),d.find("#activity-video-button")&&d.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable no-click"),d.find("#activity-gif-button")&&d.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable no-click"),d.find("#activity-media-button")&&d.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("no-click"),e.model.unset("media"),t("#message-feedabck").hasClass("noMediaError")&&e.model.unset("errors")}bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0&&e.$el.closest("#whats-new-form").removeClass("media-uploading")}),e.$el.find("#activity-post-media-uploader").addClass("open").removeClass("closed"),t("#whats-new-attachments").removeClass("empty").closest("#whats-new-form").addClass("focus-in--attm")}}),bp.Views.ActivityDocument=bp.View.extend({tagName:"div",className:"activity-document-container",template:bp.template("activity-document"),document:[],initialize:function(){this.model.set("document",this.document),this.listenTo(Backbone,"activity_document_toggle",this.toggle_document_uploader),this.listenTo(Backbone,"activity_document_close",this.destroyDocument)},toggle_document_uploader:function(){this.$el.find("#activity-post-document-uploader").hasClass("open")?this.destroyDocument():this.open_document_uploader()},destroyDocument:function(){_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),this.$el.find("#activity-post-document-uploader").html("")),this.document=[],this.$el.find("#activity-post-document-uploader").removeClass("open").addClass("closed"),t("#whats-new-attachments").addClass("empty").closest("#whats-new-form").removeClass("focus-in--attm")},open_document_uploader:function(){var e=this;if(e.$el.find("#activity-post-document-uploader").hasClass("open"))return!1;e.destroyDocument();var i={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.media.dictFileTooBig,acceptedFiles:BP_Nouveau.media.document_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.media.dropzone_document_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:_.isUndefined(BP_Nouveau.document.maxFiles)?10:BP_Nouveau.document.maxFiles,maxFilesize:_.isUndefined(BP_Nouveau.document.max_upload_size)?2:BP_Nouveau.document.max_upload_size,dictInvalidFileType:BP_Nouveau.document.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.media.document_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-document-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.media.dictCancelUploadConfirmation};bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-document-uploader",i),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(t){t.document_edit_data&&(e.document.push(t.document_edit_data),e.model.set("document",e.document))}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(i){e.$el.closest("#whats-new-form").addClass("media-uploading");var o=t(i.previewElement).find(".dz-progress-ring circle")[0],a=2*o.r.baseVal.value*Math.PI;o.style.strokeDasharray=a+" "+a,o.style.strokeDashoffset=a;var s=a-i.upload.progress.toFixed(0)/100*a;o.style.strokeDashoffset=s}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(t,i,o){o.append("action","document_document_upload"),o.append("_wpnonce",BP_Nouveau.nonces.media);var a=e.$el.parents("#whats-new-form");a.find("#activity-media-button")&&a.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-gif-button")&&a.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-video-button")&&a.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-document-button")&&a.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(i,o){if(o.data.id){bp.privacyEditable||(o.data.folder_id=bp.folder_id,o.data.group_id=bp.group_id,o.data.privacy=bp.privacy),i.id=o.data.id,o.data.uuid=i.upload.uuid,o.data.group_id=!(_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.group_id))&&BP_Nouveau.media.group_id,o.data.svg_icon=_.isUndefined(o.data.svg_icon)?"":o.data.svg_icon,o.data.saved=!1,o.data.menu_order=t(i.previewElement).closest(".dropzone").find(i.previewElement).index()-1,e.document.push(o.data),e.model.set("document",e.document);var a=i.upload.filename,s=a.substr(a.lastIndexOf(".")+1),d=_.isUndefined(o.data.svg_icon)?"":o.data.svg_icon,n=_.isEmpty(d)?"bb-icon-file-"+s:d;t(i.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&t(i.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(n)}else{var l,r,c,p,u,v=o.data.feedback;for(i.previewElement.classList.add("dz-error"),p=i.previewElement.querySelectorAll("[data-dz-errormessage]"),u=[],r=0,c=p.length;r<c;r++)l=p[r],u.push(l.textContent=v);return u}bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0==e.size?t(BP_Nouveau.media.empty_document_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(i,o){i.accepted?_.isUndefined(o)||_.isUndefined(o.data)||_.isUndefined(o.data.feedback)?"error"==i.status&&i.xhr&&0==i.xhr.status&&t(i.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):t(i.previewElement).find(".dz-error-message span").text(o.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.media.invalid_file_type+". "+(o||"")+"<div>"),this.removeFile(i),e.$el.closest("#whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(i){if(!0===bp.draft_activity.allow_delete_media){if(e.document.length){for(var o in e.document)if(i.id===e.document[o].id)_.isUndefined(e.document[o].saved)||e.document[o].saved||bp.Nouveau.Media.removeAttachment(i.id),e.document.splice(o,1),e.model.set("document",e.document);else if("edit"!==bp.draft_activity.display_post&&i.document_edit_data){var a=i.document_edit_data.id;a===e.document[o].id&&(_.isUndefined(e.document[o].saved)||e.document[o].saved||bp.Nouveau.Media.removeAttachment(a),e.document.splice(o,1),e.model.set("document",e.document))}}if(!_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)&&0===bp.Nouveau.Activity.postForm.dropzone.files.length){e.$el.closest("#whats-new-form").removeClass("media-uploading");var s=e.$el.parents("#whats-new-form");s.find("#activity-media-button")&&s.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),s.find("#activity-video-button")&&s.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),s.find("#activity-gif-button")&&s.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),s.find("#activity-document-button")&&s.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable no-click"),e.model.unset("document"),t("#message-feedabck").hasClass("noMediaError")&&e.model.unset("errors")}bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(i){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0&&e.$el.closest("#whats-new-form").removeClass("media-uploading");var o=_.isUndefined(i.name)?"":i.name,a=o.substr(o.lastIndexOf(".")+1),s=_.isUndefined(i.svg_icon)?"":i.svg_icon,d=_.isEmpty(s)?"bb-icon-file-"+a:s;t(i.previewElement).find(".dz-details .dz-icon .bb-icon-file").length&&t(i.previewElement).find(".dz-details .dz-icon .bb-icon-file").hasClass("bb-icon-file")&&t(i.previewElement).find(".dz-details .dz-icon .bb-icon-file").removeClass("bb-icon-file").addClass(d)}),e.$el.find("#activity-post-document-uploader").addClass("open").removeClass("closed"),t("#whats-new-attachments").removeClass("empty").closest("#whats-new-form").addClass("focus-in--attm")}}),bp.Views.ActivityVideo=bp.View.extend({tagName:"div",className:"activity-video-container",template:bp.template("activity-video"),video:[],videoDropzoneObj:null,editActivityData:null,initialize:function(){this.model.set("video",this.video),this.listenTo(Backbone,"activity_video_toggle",this.toggle_video_uploader),this.listenTo(Backbone,"activity_video_close",this.destroyVideo)},toggle_video_uploader:function(){this.$el.find("#activity-post-video-uploader").hasClass("open")?this.destroyVideo():this.open_video_uploader()},destroyVideo:function(){_.isNull(bp.Nouveau.Activity.postForm.dropzone)||(bp.Nouveau.Activity.postForm.dropzone.destroy(),this.$el.find("#activity-post-video-uploader").html("")),this.video=[],this.$el.find("#activity-post-video-uploader").removeClass("open").addClass("closed"),t("#whats-new-attachments").addClass("empty").closest("#whats-new-form").removeClass("focus-in--attm")},open_video_uploader:function(){var e=this;if(e.$el.find("#activity-post-video-uploader").hasClass("open"))return!1;e.destroyVideo(),this.dropzone_options={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.video.dropzone_video_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType,dictMaxFilesExceeded:BP_Nouveau.video.video_dict_file_exceeded,previewTemplate:document.getElementsByClassName("activity-post-video-template")[0].innerHTML,dictCancelUploadConfirmation:BP_Nouveau.video.dictCancelUploadConfirmation},bp.Nouveau.Activity.postForm.dropzone=new window.Dropzone("#activity-post-video-uploader",this.dropzone_options),bp.Nouveau.Activity.postForm.dropzone.on("addedfile",function(i){i.video_edit_data&&(e.video.push(i.video_edit_data),e.model.set("video",e.video)),i.dataURL&&i.video_edit_data.thumb.length?(t(i.previewElement).find(".dz-video-thumbnail").prepend('<img src=" '+i.video_edit_data.thumb+' " />'),t(i.previewElement).closest(".dz-preview").addClass("dz-has-thumbnail")):bp.Nouveau.getVideoThumb&&bp.Nouveau.getVideoThumb(i,".dz-video-thumbnail")}),bp.Nouveau.Activity.postForm.dropzone.on("sending",function(t,i,o){o.append("action","video_upload"),o.append("_wpnonce",BP_Nouveau.nonces.video);var a=e.$el.parents("#whats-new-form");a.find("#activity-media-button")&&a.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-gif-button")&&a.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-document-button")&&a.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),a.find("#activity-video-button")&&a.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("no-click")}),bp.Nouveau.Activity.postForm.dropzone.on("uploadprogress",function(i){e.$el.closest("#whats-new-form").addClass("media-uploading");var o=t(i.previewElement).find(".dz-progress-ring circle")[0],a=2*o.r.baseVal.value*Math.PI;o.style.strokeDasharray=a+" "+a;var s=a-i.upload.progress.toFixed(0)/100*a;i.upload.progress<=99?(t(i.previewElement).find(".dz-progress-count").text(i.upload.progress.toFixed(0)+"% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),o.style.strokeDashoffset=s):100===i.upload.progress&&(o.style.strokeDashoffset=a-.99*a,t(i.previewElement).find(".dz-progress-count").text("99% "+BP_Nouveau.video.i18n_strings.video_uploaded_text))}),bp.Nouveau.Activity.postForm.dropzone.on("success",function(i,o){if(100===i.upload.progress&&(t(i.previewElement).find(".dz-progress-ring circle")[0].style.strokeDashoffset=0,t(i.previewElement).find(".dz-progress-count").text("100% "+BP_Nouveau.video.i18n_strings.video_uploaded_text),t(i.previewElement).closest(".dz-preview").addClass("dz-complete")),o.data.id){bp.privacyEditable||(o.data.album_id=bp.album_id,o.data.group_id=bp.group_id,o.data.privacy=bp.privacy),i.id=o.data.id,o.data.uuid=i.upload.uuid,o.data.group_id=!(_.isUndefined(BP_Nouveau.video)||_.isUndefined(BP_Nouveau.video.group_id))&&BP_Nouveau.video.group_id,o.data.saved=!1;var a=setInterval(function(){(t(i.previewElement).closest(".dz-preview").hasClass("dz-has-no-thumbnail")||t(i.previewElement).closest(".dz-preview").hasClass("dz-has-thumbnail"))&&(o.data.js_preview=t(i.previewElement).find(".dz-video-thumbnail img").attr("src"),o.data.menu_order=t(i.previewElement).closest(".dropzone").find(i.previewElement).index()-1,e.video.push(o.data),e.model.set("video",e.video),clearInterval(a))})}else{var s,d,n,l,r,c=o.data.feedback;for(i.previewElement.classList.add("dz-error"),l=i.previewElement.querySelectorAll("[data-dz-errormessage]"),r=[],d=0,n=l.length;d<n;d++)s=l[d],r.push(s.textContent=c);return r}bp.draft_content_changed=!0}),bp.Nouveau.Activity.postForm.dropzone.on("accept",function(e,t){0==e.size?t(BP_Nouveau.video.empty_video_type):t()}),bp.Nouveau.Activity.postForm.dropzone.on("error",function(i,o){i.accepted?_.isUndefined(o)||_.isUndefined(o.data)||_.isUndefined(o.data.feedback)?"error"==i.status&&i.xhr&&0==i.xhr.status&&t(i.previewElement).find(".dz-error-message span").text(BP_Nouveau.media.connection_lost_error):t(i.previewElement).find(".dz-error-message span").text(o.data.feedback):(Backbone.trigger("onError","<div>"+BP_Nouveau.video.invalid_video_type+". "+(o||"")+"<div>"),this.removeFile(i),e.$el.closest("#whats-new-form").removeClass("media-uploading"))}),bp.Nouveau.Activity.postForm.dropzone.on("removedfile",function(i){if(!0===bp.draft_activity.allow_delete_media){if(e.video.length){for(var o in e.video)if(i.id===e.video[o].id)_.isUndefined(e.video[o].saved)||e.video[o].saved||bp.Nouveau.Media.removeAttachment(i.id),e.video.splice(o,1),e.model.set("video",e.video);else if("edit"!==bp.draft_activity.display_post&&i.video_edit_data){var a=i.video_edit_data.id;a===e.video[o].id&&(_.isUndefined(e.video[o].saved)||e.video[o].saved||bp.Nouveau.Media.removeAttachment(a),e.video.splice(o,1),e.model.set("video",e.video))}}if(!_.isNull(bp.Nouveau.Activity.postForm.dropzone.files)&&0===bp.Nouveau.Activity.postForm.dropzone.files.length){e.$el.closest("#whats-new-form").removeClass("media-uploading");var s=e.$el.parents("#whats-new-form");s.find("#activity-media-button")&&s.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),s.find("#activity-gif-button")&&s.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),s.find("#activity-document-button")&&s.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),e.model.unset("video"),t("#message-feedabck").hasClass("noMediaError")&&e.model.unset("errors")}bp.draft_content_changed=!0}}),bp.Nouveau.Activity.postForm.dropzone.on("complete",function(){if(0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&this.files.length>0){var t=e.$el.closest("#whats-new-form");void 0===t||t.hasClass("draft-video-uploading")||t.removeClass("media-uploading")}}),e.$el.find("#activity-post-video-uploader").addClass("open").removeClass("closed"),t("#whats-new-attachments").removeClass("empty").closest("#whats-new-form").addClass("focus-in--attm"),t("#whats-new-form").closest("body").addClass("video-post-form-open")},createVideoThumbnailFromUrl:function(e){var t=this;t.videoDropzoneObj.createVideoThumbnailFromUrl(e,t.videoDropzoneObj.options.thumbnailWidth,t.videoDropzoneObj.options.thumbnailHeight,t.videoDropzoneObj.options.thumbnailMethod,!0,function(i){t.videoDropzoneObj.emit("thumbnail",e,i),t.videoDropzoneObj.emit("complete",e)})}}),bp.Views.ActivityLinkPreview=bp.View.extend({tagName:"div",className:"activity-url-scrapper-container",template:bp.template("activity-link-preview"),events:{"click #activity-link-preview-button":"toggleURLInput","click #activity-url-prevPicButton":"prev","click #activity-url-nextPicButton":"next","click #activity-link-preview-remove-image":"close","click #activity-close-link-suggestion":"destroy","click .icon-exchange":"displayPrevNextButton","click #activity-link-preview-select-image":"selectImageForPreview"},initialize:function(){this.model.set("link_scrapping",!1),this.model.set("link_embed",!1),this.listenTo(this.model,"change",this.render),document.addEventListener("activity_link_preview_open",this.open.bind(this)),document.addEventListener("activity_link_preview_close",this.destroy.bind(this))},render:function(){if(!0!=this.model.get("posting"))return this.$el.html(this.template(this.model.toJSON())),void 0!==this.model.get("link_swap_image_button")&&1===this.model.get("link_swap_image_button")&&this.displayNextPrevButtonView(),!0==this.model.get("link_embed")?(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(this.el),this.$el.addClass("activity-post-form-link-wp-embed")):this.$el.removeClass("activity-post-form-link-wp-embed"),this},prev:function(){var e=this.model.get("link_image_index");e>0&&this.model.set("link_image_index",e-1)},next:function(){var e=this.model.get("link_image_index");e<this.model.get("link_images").length-1&&(this.model.link_image_index++,this.model.set("link_image_index",e+1))},open:function(e){e.preventDefault(),this.model.set("link_scrapping",!0),this.$el.addClass("open")},close:function(e){e.preventDefault(),this.model.set({link_images:[],link_image_index:0,link_image_index_save:"0"})},destroy:function(e){_.isUndefined(e)||e.preventDefault(),this.model.set({link_success:!1,link_error:!1,link_error_msg:"",link_scrapping:!1,link_images:[],link_image_index:0,link_title:"",link_description:"",link_url:"",link_embed:!1,link_swap_image_button:0,link_image_index_save:"0"}),document.removeEventListener("activity_link_preview_open",this.open.bind(this)),document.removeEventListener("activity_link_preview_close",this.destroy.bind(this)),t("#whats-new").removeData("activity-url-preview"),t("#whats-new-attachments").addClass("empty").closest("#whats-new-form").removeClass("focus-in--attm")},displayPrevNextButton:function(e){e.preventDefault(),this.model.set("link_swap_image_button",1),this.displayNextPrevButtonView()},displayNextPrevButtonView:function(){t("#activity-url-prevPicButton").show(),t("#activity-url-nextPicButton").show(),t("#activity-link-preview-select-image").show(),t("#icon-exchange").hide(),t("#activity-link-preview-remove-image").hide()},selectImageForPreview:function(e){e.preventDefault();var i=this.model.get("link_image_index");this.model.set("link_image_index_save",i),t("#icon-exchange").show(),t("#activity-link-preview-remove-image").show(),t("#activity-link-preview-select-image").hide(),t("#activity-url-prevPicButton").hide(),t("#activity-url-nextPicButton").hide()}}),bp.Views.ActivityAttachedGifPreview=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("activity-attached-gif"),standalone:!1,events:{"click .gif-image-remove":"destroy"},initialize:function(e){this.destroy=this.destroy.bind(this),e&&void 0!==e.standalone&&(this.standalone=e.standalone),this.listenTo(this.model,"change",this.render),this.listenTo(Backbone,"activity_gif_close",this.destroy)},render:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("gif_data");return!_.isEmpty(e)&&(this.el.style.backgroundImage="url("+e.images.fixed_width.url+")",this.el.style.backgroundSize="contain",this.el.style.minHeight=e.images.original.height+"px",this.el.style.width=e.images.original.width+"px",t("#whats-new-attachments").removeClass("empty").closest("#whats-new-form").addClass("focus-in--attm"),_.isUndefined(bp.draft_activity.data.gif_data)||bp.draft_activity.data.gif_data.id===e.id?_.isUndefined(bp.draft_activity.data.gif_data)&&(bp.draft_content_changed=!0):bp.draft_content_changed=!0),this},destroy:function(e){var i=this.model.get("gif_data");this.model.set("gif_data",{}),t("#message-feedabck").hasClass("noMediaError")&&this.model.unset("errors"),this.el.style.backgroundImage="",this.el.style.backgroundSize="",this.el.style.minHeight="0px",this.el.style.width="0px",t("#whats-new-attachments").addClass("empty").closest("#whats-new-form").removeClass("focus-in--attm");var o=this.$el.parents("#whats-new-form");o.find("#activity-document-button")&&(o.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable"),o.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("no-click")),o.find("#activity-media-button")&&(o.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable"),o.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("no-click")),o.find("#activity-video-button")&&(o.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("disable"),o.find("#activity-video-button").parents(".post-elements-buttons-item").removeClass("no-click")),o.find("#activity-gif-button")&&(o.find("#activity-gif-button").removeClass("open").parents(".post-elements-buttons-item").removeClass("active"),o.find("#activity-gif-button").removeClass("open").parents(".post-elements-buttons-item").removeClass("no-click"));var a=this.$el.parents(".bp-ac-form-container");if(this.standalone?this.$el.closest(".screen-content, .elementor-widget-container, .buddypress-wrap").find("#activity-modal .ac-form").removeClass("has-gif"):this.$el.closest(".ac-form").removeClass("has-gif"),a.find(".ac-reply-toolbar .ac-reply-media-button")&&(a.find(".ac-reply-toolbar .ac-reply-media-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find(".ac-reply-toolbar .ac-reply-media-button").parents(".post-elements-buttons-item").removeClass("no-click")),a.find(".ac-reply-toolbar .ac-reply-document-button")&&(a.find(".ac-reply-toolbar .ac-reply-document-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find(".ac-reply-toolbar .ac-reply-document-button").parents(".post-elements-buttons-item").removeClass("no-click")),a.find(".ac-reply-toolbar .ac-reply-video-button")&&(a.find(".ac-reply-toolbar .ac-reply-video-button").parents(".post-elements-buttons-item").removeClass("disable"),a.find(".ac-reply-toolbar .ac-reply-video-button").parents(".post-elements-buttons-item").removeClass("no-click")),a.find(".ac-reply-toolbar .ac-reply-gif-button")&&(a.find(".ac-reply-toolbar .ac-reply-gif-button").removeClass("active"),a.find(".ac-reply-toolbar .ac-reply-gif-button").removeClass("no-click")),a.find(".ac-textarea").children(".ac-input").length>0){var s=a.find(".ac-textarea").children(".ac-input").html(),d=t.trim(s.replace(/<div>/gi,"\n").replace(/<\/div>/gi,""));d=d.replace(/&nbsp;/g," "),""!==a.find(".ac-textarea").children(".ac-input").text().trim()||d.indexOf("emojioneemoji")>=0?t(a).closest("form").addClass("has-content"):t(a).closest("form").removeClass("has-content")}!_.isUndefined(e)&&!_.isEmpty(i)&&_.isEmpty(this.model.get("gif_data"))&&(bp.draft_content_changed=!0)}}),bp.Views.GifMediaSearchDropdown=bp.View.extend({tagName:"div",className:"activity-attached-gif-container",template:bp.template("gif-media-search-dropdown"),total_count:0,offset:0,limit:20,q:null,requests:[],standalone:!1,events:{"keydown .search-query-input":"search","click .found-media-item":"select"},initialize:function(e){this.select=this.select.bind(this),e&&void 0!==e.standalone&&(this.standalone=e.standalone),this.options=e||{},this.giphy=new window.Giphy(BP_Nouveau.media.gif_api_key),this.gifDataItems=new bp.Collections.GifDatas,this.listenTo(this.gifDataItems,"add",this.addOne),this.listenTo(this.gifDataItems,"reset",this.addAll),document.addEventListener("scroll",_.bind(this.loadMore,this),!0)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$gifResultItem=this.$el.find(".gif-search-results-list"),this.loadTrending(),this},search:function(e){if("Enter"===e.key||13===e.keyCode)return e.preventDefault(),!1;var t=this;if(null!=this.Timeout&&clearTimeout(this.Timeout),""===e.target.value)return void this.loadTrending();this.Timeout=setTimeout(function(){this.Timeout=null,t.searchGif(e.target.value)},1e3)},searchGif:function(e){var i=this;i.q=e,i.offset=0,i.clearRequests(),i.el.classList.add("loading"),this.$el.find(".gif-no-results").removeClass("show"),this.$el.find(".gif-no-connection").removeClass("show");var o=i.giphy.search({q:e,offset:i.offset,fmt:"json",limit:this.limit},function(e){void 0!==e.data.length&&0===e.data.length&&t(i.el).find(".gif-no-results").addClass("show"),void 0!==e.meta.status&&200!==e.meta.status&&t(i.el).find(".gif-no-connection").addClass("show"),i.gifDataItems.reset(e.data),i.total_count=e.pagination.total_count,i.el.classList.remove("loading")},function(){t(i.el).find(".gif-no-connection").addClass("show")});i.requests.push(o),i.offset=i.offset+i.limit},select:function(e){e.preventDefault(),this.$el.parent().removeClass("open");var t=this.gifDataItems.findWhere({id:e.currentTarget.dataset.id});this.model.set("gif_data",t.attributes);var i=this.$el.parents("#whats-new-form");i.find("#activity-document-button")&&i.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("disable"),i.find("#activity-media-button")&&i.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),i.find("#activity-video-button")&&i.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("disable");var o=this.$el.parents(".ac-reply-content");o.find(".ac-reply-toolbar .ac-reply-media-button")&&o.find(".ac-reply-toolbar  .ac-reply-media-button").parents(".post-elements-buttons-item").addClass("disable"),o.find(".ac-reply-toolbar .ac-reply-document-button")&&o.find(".ac-reply-toolbar  .ac-reply-document-button").parents(".post-elements-buttons-item").addClass("disable"),o.find(".ac-reply-toolbar .ac-reply-video-button")&&o.find(".ac-reply-toolbar  .ac-reply-video-button").parents(".post-elements-buttons-item").addClass("disable");var a=this.$el.closest("#whats-new-form");this.standalone?this.$el.closest(".screen-content, .elementor-widget-container, .buddypress-wrap").find("#activity-modal .ac-form").addClass("has-gif"):this.$el.closest(".ac-form").addClass("has-gif");var s=a.find(".whats-new-scroll-view");s.length>0&&s.stop().animate({scrollTop:s[0].scrollHeight},300),e.stopPropagation()},addOne:function(e){var t=new bp.Views.GifDataItem({model:e});this.$gifResultItem.append(t.render().el)},addAll:function(){this.$gifResultItem.html(""),this.gifDataItems.each(this.addOne,this)},loadTrending:function(){var e=this;e.offset=0,e.q=null,e.clearRequests(),e.el.classList.add("loading");var t=e.giphy.trending({offset:e.offset,fmt:"json",limit:this.limit},function(t){e.gifDataItems.reset(t.data),e.total_count=t.pagination.total_count,e.el.classList.remove("loading")});e.requests.push(t),e.offset=e.offset+e.limit},loadMore:function(e){if("gif-search-results"===e.target.id){var t=e.target;if(t.scrollTop+t.offsetHeight>=t.scrollHeight&&!t.classList.contains("loading")&&this.total_count>0&&this.offset<=this.total_count){var i={offset:this.offset,fmt:"json",limit:this.limit};this.el.classList.add("loading");var o=null;o=_.isNull(this.q)?this.giphy.trending(i,_.bind(this.loadMoreResponse,this)):this.giphy.search(_.extend({q:this.q},i),_.bind(this.loadMoreResponse,this)),this.requests.push(o),this.offset=this.offset+this.limit}}},clearRequests:function(){this.gifDataItems.reset();for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]},loadMoreResponse:function(e){this.el.classList.remove("loading"),this.gifDataItems.add(e.data)}}),bp.Views.GifDataItem=bp.View.extend({tagName:"li",template:wp.template("gif-result-item"),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),window.addEventListener("resize",this.render.bind(this))},render:function(){var e=Math.floor(6*Math.random())+1,t=this.model.get("images"),i=window.innerWidth>768?140:130,o=t.original.width,a=t.original.height;return this.$el.html(this.template(this.model.toJSON())),this.el.classList.add("bg"+e),this.el.style.height=i*a/o+"px",this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&(_.each(this.options,function(e,t){this.$el.prop(t,e)},this),this.listenTo(this.model,"change:link_loading",this.onLinkScrapping))},onLinkScrapping:function(){this.$el.prop("disabled",!1)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"div",id:"whats-new",attributes:{"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,"data-suggestions-group-id":!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object&&BP_Nouveau.activity.params.item_id},loadURLAjax:null,loadedURLs:[],initialize:function(){this.on("ready",this.adjustContent,this),this.on("ready",this.activateToastUIEditor,this),this.options.activity.on("change:content",this.resetContent,this),this.linkTimeout=null},adjustContent:function(){var e=bp.Nouveau.getLinkParams(null,"r")||null;if(!_.isNull(e)){var t="@"+_.escape(e)+" ";window.activity_editor?(window.activity_editor.setHTML(t),window.activity_editor.focus()):this.$el.html(t)}},resetContent:function(e){_.isUndefined(e)||(window.activity_editor?window.activity_editor.setHTML(e.get("content")||""):this.$el.html(e.get("content")))},scrapURL:function(e){var t="",i=this.$el.closest("#whats-new").data("activity-url-preview");if(null!==e||void 0!==i){var o=new DOMParser().parseFromString(e,"text/html");if(o.querySelectorAll("a.bp-suggestions-mention").forEach(function(e){e.remove()}),(e=o.body.innerHTML).indexOf("<img")>=0&&(e=e.replace(/<img .*?>/g,"")),e.indexOf("http://")>=0?t=this.getURL("http://",e):e.indexOf("https://")>=0?t=this.getURL("https://",e):e.indexOf("www.")>=0&&(t=this.getURL("www",e)),""!==t){var a=document.createElement("a");a.href=t;var s=a.hostname;-1!==BP_Nouveau.activity.params.excluded_hosts.indexOf(s)&&(t="")}""!==t?this.loadURLPreview(t):void 0!==i&&this.loadURLPreview(i)}},getURL:function(e,i){var o="",a=(i=i.replace(/&nbsp;/g,"")).indexOf(e),s="";if(_.isUndefined(t(t.parseHTML(i)).attr("href"))){for(var d=a;d<i.length;d++)if(" "===i[d]||"\n"===i[d]||'"'===i[d]&&">"===i[d+1]||"<"===i[d]&&"b"===i[d+1]&&"r"===i[d+2])break;else o+=i[d];"www"===e&&(o=(e="http://")+o)}else o=t(i).attr("href");var n=document.createElement("div");n.innerHTML=o;for(var l=n.getElementsByTagName("*");l[0];)l[0].parentNode.removeChild(l[0]);return n.innerHTML.length>0&&(s=n.innerHTML),s},loadURLPreview:function(e){var i=this;if(e=t.trim(e),/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,24}(:[0-9]{1,5})?(\/.*)?$/.test(e)){if(!_.isUndefined(i.options.activity.get("link_success"))&&!0==i.options.activity.get("link_success")&&i.options.activity.get("link_url")===e||e.includes(window.location.hostname)&&(e.includes("download_document_file")||e.includes("download_media_file")||e.includes("download_video_file")))return!1;var o=!1;i.loadedURLs.length&&t.each(i.loadedURLs,function(t,i){if(i.url==e)return o=i.response,!1}),null!=i.loadURLAjax&&i.loadURLAjax.abort(),i.options.activity.set({link_scrapping:!0,link_loading:!0,link_error:!1,link_url:e,link_embed:!1}),o?i.setURLResponse(o,e):i.loadURLAjax=bp.ajax.post("bp_activity_parse_url",{url:e}).always(function(t){i.setURLResponse(t,e)})}},setURLResponse:function(e,i){if(this.options.activity.set("link_loading",!1),""===e.title&&""===e.images)return void this.options.activity.set("link_scrapping",!1);if(""===e.error){var o=e.images;!0===this.options.activity.get("edit_activity")&&void 0===this.options.activity.get("link_image_index_save")&&""===this.options.activity.get("link_image_index_save")&&(o="");var a="";""!==this.options.activity.get("link_image_index")&&(a=parseInt(this.options.activity.get("link_image_index")));var s=this.$el.closest("#whats-new").data("activity-url-preview"),d=this.options.activity.get("link_image_index_save");""!==s&&s!==i&&(a=0,d=0,this.$el.closest("#whats-new").data("activity-url-preview",i)),this.options.activity.set({link_success:!0,link_title:_.isUndefined(e.title)?"":e.title,link_description:_.isUndefined(e.description)?"":e.description,link_images:o,link_image_index:a,link_image_index_save:d,link_embed:!_.isUndefined(e.wp_embed)&&e.wp_embed}),t("#whats-new-attachments").removeClass("empty").closest("#whats-new-form").addClass("focus-in--attm"),t("#whats-new-attachments").hasClass("activity-video-preview")&&t("#whats-new-attachments").removeClass("activity-video-preview"),t("#whats-new-attachments").hasClass("activity-link-preview")&&t("#whats-new-attachments").removeClass("activity-link-preview"),t(".activity-media-container").length&&(void 0!==e.description&&e.description.indexOf("iframe")>-1||!_.isUndefined(e.wp_embed)&&e.wp_embed?t("#whats-new-attachments").addClass("activity-video-preview"):t("#whats-new-attachments").addClass("activity-link-preview")),this.loadedURLs.push({url:i,response:e})}else this.options.activity.set({link_success:!1,link_error:!0,link_error_msg:e.error})},activateToastUIEditor:function(){var e=this,i=this.$el[0];console.log("WhatsNew.activateToastUIEditor: Entered.");var o=!t(i).closest(".edit-activity-modal-body").length;if(console.log('WhatsNew.activateToastUIEditor: Condition !$(editorElement).closest(".edit-activity-modal-body").length is',o),!_.isUndefined(window.toastui)&&o){console.log("WhatsNew.activateToastUIEditor: Condition met. Initializing ToastUI editor for #whats-new."),window.activity_editor&&"function"==typeof window.activity_editor.destroy&&(console.log("WhatsNew.activateToastUIEditor: Destroying previous window.activity_editor."),window.activity_editor.destroy()),window.activity_editor=new toastui.Editor({el:i,initialEditType:"wysiwyg",previewStyle:"tab",height:"auto",minHeight:"100px",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder||"",initialValue:this.$el.html(),toolbarItems:[["bold","italic"],["ul","ol"],["quote"],["link"],["codeblock"]],events:{change:function(){_.isUndefined(BP_Nouveau.activity.params.link_preview)||(null!=e.linkTimeout&&clearTimeout(e.linkTimeout),e.linkTimeout=setTimeout(function(){e.linkTimeout=null,e.scrapURL(window.activity_editor.getHTML())},500));var i=t(window.activity_editor.getEditorElements().wwEditor).closest(".whats-new-scroll-view");i.length&&(i.prop("scrollHeight")>i.prop("clientHeight")?i.closest("#whats-new-form").addClass("focus-in--scroll"):i.closest("#whats-new-form").removeClass("focus-in--scroll")),e.$el.closest("form#whats-new-form").trigger("input")}},hooks:{paste:function(e){return setTimeout(function(){var e=window.activity_editor.getEditorElements().wwEditor;if(e){var i=t(e).find("li").filter(function(){return!t(this).parent().is("ul")&&!t(this).parent().is("ol")});if(i.length>0){var o=t("<ul></ul>");i.first().before(o),o.append(i);var a=t(e).html();window.activity_editor.setHTML(a)}}},0),e}}}),console.log("WhatsNew.activateToastUIEditor: window.activity_editor assigned:",window.activity_editor);var a=bp.Nouveau.getLinkParams(null,"r")||null;!_.isNull(a)&&window.activity_editor&&window.activity_editor.focus()}else console.log("WhatsNew.activateToastUIEditor: Condition NOT met or toastui undefined. Editor not initialized/assigned to window.activity_editor.")}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(e,i){return{el:t("<option></option>").val(i).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var e=this.filters[this.el.value];e&&this.model.set({selected:this.el.value,placeholder:e.autocomplete_placeholder})}}),bp.Views.ActivityPrivacy=bp.View.extend({tagName:"div",id:"activity-post-form-privacy",template:bp.template("activity-post-form-privacy"),initialize:function(){this.model=new bp.Models.Activity}}),bp.Views.Item=bp.View.extend({tagName:"div",className:"bp-activity-object",template:bp.template("activity-target-item"),initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){e.preventDefault();var i=t("#whats-new-form");!0===this.model.get("selected")?(this.model.unset("selected"),t("#whats-new").attr("data-suggestions-group-id",!1).data("suggestions-group-id",!1)):t("#whats-new").attr("data-suggestions-group-id",this.model.get("id")).data("suggestions-group-id",this.model.get("id")),i.removeClass("focus-in--blank-group");var o=this;if(o.model.hasOwnProperty("attributes")&&o.model.attributes.hasOwnProperty("object_type")&&"group"===o.model.attributes.object_type){var a=_.find(this.model.collection.models,function(e){return e!==o.model&&e.get("selected")});a&&a.set("selected",!1)}this.model.set("selected",!0);var s=this.model.attributes;void 0!==s.group_media&&!1===s.group_media?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-media-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),void 0!==s.group_document&&!1===s.group_document?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-document-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),void 0!==s.group_video&&!1===s.group_video?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-video-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide")}}),bp.Views.AutoComplete=bp.View.extend({tagName:"div",id:"whats-new-post-in-box-items",ac_req:!1,events:{keyup:"autoComplete"},initialize:function(){var e=new bp.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();if(this.$el.html(e.$el),e.$el.wrapAll('<span class="activity-autocomplete-wrapper" />').after('<span class="activity-autocomplete-clear"><i class="bb-icon-rl bb-icon-times"></i></span>'),this.$el.append('<div id="bp-activity-group-ac-items"></div>'),this.on("ready",this.setFocus,this),"group"===this.options.type){var t=BP_Nouveau.activity.params.objects.group_list;t&&(this.collection.add(t),_.each(this.collection.models,function(e){this.addItemView(e)},this));var i=BP_Nouveau.activity.params.objects.group_total_page,o=BP_Nouveau.activity.params.objects.group_count;if(i>1&&o>this.collection.models.length){var a=this;this.$el.find("#bp-activity-group-ac-items").addClass("group_scrolling load_more_data");var s=this.$el.find("#bp-activity-group-ac-items"),d=1;s.on("scroll",function(){if(window.acScrollPosition=s.scrollTop(),a.$el.find("#bp-activity-group-ac-items").hasClass("load_more_data")){if(++d>i)return a.$el.find("#bp-activity-group-ac-items").removeClass("load_more_data"),d=1,!1;a.loadMoreData(a,d)}})}}this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){if(this.$el.find("#activity-autocomplete").focus(),t("#bp-activity-group-ac-items .bp-activity-object").length){var e=t("#bp-activity-group-ac-items");t(".bp-activity-object").each(function(){t(this).hasClass("selected")&&(e.scrollTop(window.acScrollPosition),e.on("scroll",function(){window.acScrollPosition=t(this).scrollTop()}))})}},addItemView:function(e){var t=new bp.Views.Item({model:e});this.$el.find("#bp-activity-group-ac-items").append(t.render().$el)},autoComplete:function(){var e=t("#activity-autocomplete").val(),i=this.$el.closest("#whats-new-form");0===parseInt(e.length)?(this.autoCompleteCollectionData(this,e),this.$el.find("#bp-activity-group-ac-items").addClass("load_more_data"),this.$el.removeClass("activity-is-autocomplete"),i.addClass("focus-in--blank-group")):(this.$el.addClass("activity-is-autocomplete"),t("#whats-new-post-in-box-items .activity-autocomplete-clear").on("click",function(){t("#activity-autocomplete").val("").keyup(),i.addClass("focus-in--blank-group")})),2>e.length||this.autoCompleteCollectionData(this,e)},autoCompleteCollectionData:function(e,t){this.collection.reset(),this.ac_req&&this.ac_req.abort(),"group"===this.options.type?(this.$el.find("#bp-activity-group-ac-items").html('<div class="groups-selection groups-selection--finding"><i class="dashicons dashicons-update animate-spin"></i><span class="groups-selection__label">'+BP_Nouveau.activity.params.objects.group.finding_group_placeholder+"</span></div>"),this.$el.find("#bp-activity-group-ac-items").addClass("group_scrolling--revive")):this.$el.find("#bp-activity-group-ac-items").html('<i class="dashicons dashicons-update animate-spin"></i>');var i={type:this.options.type,nonce:BP_Nouveau.nonces.activity};""!==t&&(i.search=t),this.ac_req=this.collection.fetch({data:i,success:_.bind(this.itemFetched,this,e.options.type),error:_.bind(this.itemFetched,this,e.options.type)})},itemFetched:function(e,t){t.length||this.cleanView(e),"group"===e?(this.$el.find("#bp-activity-group-ac-items").find(".groups-selection--finding").remove(),this.$el.find("#bp-activity-group-ac-items").removeClass("group_scrolling--revive")):this.$el.find("#bp-activity-group-ac-items").find("i.dashicons").remove()},cleanView:function(e){"group"===e?this.$el.find("#bp-activity-group-ac-items").html('<span class="groups-selection groups-selection--no-groups">'+BP_Nouveau.activity.params.objects.group.no_groups_found+"</span>"):this.$el.find("#bp-activity-group-ac-items").html(""),_.each(this.views._views[""],function(e){e.remove()})},loadMoreData:function(e,i){this.$el.find("#bp-activity-group-ac-items .groups-selection--loading").length||this.$el.find("#bp-activity-group-ac-items .bp-activity-object:last").after('<div class="groups-selection groups-selection--loading"><i class="dashicons dashicons-update animate-spin"></i><span class="groups-selection__label">'+BP_Nouveau.activity.params.objects.group.loading_group_placeholder+"</span></div>");var o=!1;return new bp.Collections.fetchCollection().fetch({type:"POST",data:{type:e.options.type,nonce:BP_Nouveau.nonces.activity,page:i,action:"bp_nouveau_get_activity_objects"},success:function(i,a){!0===a.success&&(e.collection.add(a.data),t("#bp-activity-group-ac-items .groups-selection--loading").remove(),o=!0)}}),o}}),bp.Views.UserStatusHuddle=bp.View.extend({tagName:"div",id:"user-status-huddle",className:"bp-activity-huddle",initialize:function(){this.views.add(new bp.Views.CaseAvatar({model:this.model})),this.views.add(new bp.Views.CaseHeading({model:this.model})),this.views.add(new bp.Views.CasePrivacy({model:this.model})),void 0!==bp.Views.PostScheduleTime&&this.views.add(new bp.Views.PostScheduleTime({model:this.model})),t("#whats-new-heading, #whats-new-status").wrapAll('<div class="activity-post-name-status" />'),setTimeout(function(){t(".activity-singular #whats-new-heading, .activity-singular #whats-new-status, .activity-singular #activity-schedule-section").wrapAll('<div class="activity-post-name-status" />')},1e3)}}),bp.Views.CaseAvatar=bp.View.extend({tagName:"div",id:"whats-new-avatar",template:bp.template("activity-post-case-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CaseHeading=bp.View.extend({tagName:"div",id:"whats-new-heading",template:bp.template("activity-post-case-heading"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain","user_display_name"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),bp.Views.CasePrivacy=bp.View.extend({tagName:"div",id:"whats-new-status",template:bp.template("activity-post-case-privacy"),events:{"click #bp-activity-privacy-point":"privacyTarget"},initialize:function(){this.listenTo(Backbone,"privacy:updatestatus",this.updateStatus),this.model.on("change:privacy",this.render,this)},render:function(){if(this.$el.html(this.template(this.model.toJSON())),!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object){this.model.set("item_name",BP_Nouveau.activity.params.item_name),this.model.set("privacy","group");var e=BP_Nouveau.activity.params.item_name;t("#whats-new-form").find(".bp-activity-privacy-status").text(e),this.$el.find("#bp-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),BP_Nouveau.activity.params.group_avatar&&!1===BP_Nouveau.activity.params.group_avatar.includes("mystery-group")?this.$el.find("#bp-activity-privacy-point span.privacy-point-icon").removeClass("privacy-point-icon").addClass("group-privacy-point-icon").html('<img src="'+BP_Nouveau.activity.params.group_avatar+'" alt=""/>'):(this.$el.find("#bp-activity-privacy-point span.group-privacy-point-icon img").remove(),this.$el.find("#bp-activity-privacy-point span.group-privacy-point-icon").removeClass("group-privacy-point-icon").addClass("privacy-point-icon"))}return!_.isUndefined(bp.draft_activity)&&""!==bp.draft_activity.object&&"group"===bp.draft_activity.object&&bp.draft_activity.data&&""!==bp.draft_activity.data&&(this.model.set("item_name",bp.draft_activity.data.item_name),this.model.set("privacy","group"),t("#whats-new-form").find(".bp-activity-privacy-status").text(bp.draft_activity.data.item_name),this.$el.find("#bp-activity-privacy-point").removeClass().addClass("group bp-activity-focus-group-active"),bp.draft_activity.data.group_image&&!1===bp.draft_activity.data.group_image.includes("mystery-group")?this.$el.find("#bp-activity-privacy-point span.privacy-point-icon").removeClass("privacy-point-icon").addClass("group-privacy-point-icon").html('<img src="'+bp.draft_activity.data.group_image+'" alt=""/>'):(this.$el.find("#bp-activity-privacy-point span.group-privacy-point-icon img").remove(),this.$el.find("#bp-activity-privacy-point span.group-privacy-point-icon").removeClass("group-privacy-point-icon").addClass("privacy-point-icon"))),this},updateStatus:function(){this.model.get("privacy")},privacyTarget:function(e){if(this.$el.find("#bp-activity-privacy-point").hasClass("bp-activity-edit-group")||!_.isUndefined(BP_Nouveau.activity.params.object)&&"group"===BP_Nouveau.activity.params.object||!bp.privacyEditable)return!1;e.preventDefault(),t("#activity-post-form-privacy").show(),t("#whats-new-form").addClass("focus-in--privacy"),Backbone.trigger("privacy:headerupdate"),t("#whats-new-form").hasClass("bp-activity-edit")&&this.model.set("privacy",this.$el.closest("#whats-new-form").find(".bp-activity-privacy__input:checked").val())}}),bp.Views.PrivacyStage=bp.View.extend({tagName:"div",id:"whats-new-privacy-stage",className:"bp-activity-privacy-stage",events:{"click #privacy-status-submit":"privacyStatusSubmit","click #privacy-status-back":"backPrivacySelector","click #privacy-status-group-back":"backGroupSelector","click input.bp-activity-privacy__input":"privacySelector"},initialize:function(){if(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object){var e=new bp.Views.PrivacyStageBody({model:this.model});this.views.add(e)}this.views.add(new bp.Views.PrivacyStageFooter({model:this.model}))},privacyStatusSubmit:function(e){e.preventDefault();var i=this.$el.find(".bp-activity-privacy__input:checked").val();this.model.set("privacy",i),this.model.set("privacy_modal","general"),_.isUndefined(BP_Nouveau.media)||(bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}));var o=t("#whats-new-form");o.removeClass("focus-in--privacy focus-in--group"),Backbone.trigger("privacy:updatestatus");var a=this.model.attributes.item_id;if("group"===i){var s=o.find("#bp-item-opt-"+a).data("title");o.find(".bp-activity-privacy-status").text(s),o.find("#bp-activity-privacy-point").removeClass().addClass(i),this.model.set("item_name",s),this.model.set("group_name",s),this.model.attributes.group_image&&!1===this.model.attributes.group_image.includes("mystery-group")?(o.find("#bp-activity-privacy-point span.privacy-point-icon").removeClass("privacy-point-icon").addClass("group-privacy-point-icon"),o.find("#bp-activity-privacy-point span.group-privacy-point-icon").html('<img src="'+this.model.attributes.group_image+'" alt=""/>')):(o.find("#bp-activity-privacy-point span.group-privacy-point-icon img").remove(),o.find("#bp-activity-privacy-point span.group-privacy-point-icon").removeClass("group-privacy-point-icon").addClass("privacy-point-icon")),_.isUndefined(BP_Nouveau.media)||(bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}));var d=o.find("#bp-item-opt-"+a).data("allow-schedule-post");_.isUndefined(d)||"enabled"!==d?"scheduled"===this.model.attributes.activity_action_type?(this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),this.model.set("schedule_allowed","disabled"),o.find(".bb-schedule-post_dropdown_section").addClass("bp-hide"),Backbone.trigger("onError",BP_Nouveau.activity_schedule.strings.notAllowScheduleWarning,"error")):(this.model.set("schedule_allowed","disabled"),o.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):(this.model.set("schedule_allowed",d),o.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack"));var n=o.find("#bp-item-opt-"+a).data("allow-polls");_.isUndefined(n)||"enabled"!==n?(this.model.set("polls_allowed","disabled"),this.model.set("poll",{}),this.model.set("poll_id",""),o.find(".bb-post-poll-button").addClass("bp-hide")):(this.model.set("polls_allowed",n),o.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack"))}else{_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed?(this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),this.model.set("schedule_allowed","disabled"),o.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):o.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity?(this.model.set("polls_allowed","disabled"),this.model.set("poll",{}),this.model.set("poll_id",""),o.find(".bb-post-poll-button").addClass("bp-hide")):o.find(".bb-post-poll-button").removeClass("bp-hide"),Backbone.trigger("cleanFeedBack");var l=this.model.attributes.privacy,r=o.find("#"+l).data("title");o.find("#bp-activity-privacy-point").removeClass().addClass(l),o.find(".bp-activity-privacy-status").text(r),o.find(".bp-activity-privacy__input#"+l).prop("checked",!0),o.find("#bp-activity-privacy-point span.group-privacy-point-icon img").remove(),o.find("#bp-activity-privacy-point span.group-privacy-point-icon").removeClass("group-privacy-point-icon").addClass("privacy-point-icon"),this.model.set("item_id",0),this.model.set("item_name",""),this.model.set("group_name",""),this.model.set("group_image",""),this.model.set("group-privacy",""),bp.draft_activity.data.item_id=0,bp.draft_activity.data.group_name="",bp.draft_activity.data.group_image="",bp.draft_activity.data.item_name="",bp.draft_activity.data.privacy=l,bp.draft_activity.data["group-privacy"]="",bp.Nouveau.Activity.postForm.checkAndStoreDraftToLocalStorage(bp.draft_activity)}},backPrivacySelector:function(e){e.preventDefault();var i=this.model.get("privacy");t("#whats-new-form").removeClass("focus-in--privacy focus-in--group"),this.model.set("privacy_modal","general"),this.$el.find("input#"+i).prop("checked",!0),t("#whats-new-form").hasClass("bp-activity-edit")&&this.model.set("privacy",this.$el.find(".bp-activity-privacy__input:checked").val())},backGroupSelector:function(e){e.preventDefault();var i=t("#whats-new-form");this.model.set("privacy_modal","profile"),i.removeClass("focus-in--group");var o=this.model.get("privacy");this.$el.find("input#"+o).prop("checked",!0),t("#activity-post-form-privacy").show(),i.removeClass("focus-in--blank-group")},privacySelector:function(e){var i=t("#whats-new-form");"group"===t(e.currentTarget).val()?(t(e.currentTarget).closest("#whats-new-privacy-stage").find("#whats-new-post-in").val("group").trigger("change"),i.addClass("focus-in--group"),this.model.set("privacy_modal","group"),this.model.set("object",t(e.currentTarget).val()),t("#activity-post-form-privacy").hide(),0===this.model.attributes.item_id&&i.addClass("focus-in--blank-group")):(t("#privacy-status-submit").click(),this.model.set("object","user"),t("#whats-new").attr("data-suggestions-group-id",!1).data("suggestions-group-id",!1),Backbone.trigger("mediaprivacytoolbar")),bp.mentions.clearCache()}}),bp.Views.PrivacyStageBody=bp.View.extend({tagName:"div",id:"whats-new-privacy-stage-body",className:"privacy-status-form-body",initialize:function(){if(!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length||!_.isUndefined(BP_Nouveau.activity.params.object)&&"user"===BP_Nouveau.activity.params.object){var e=new bp.Views.ActivityPrivacy({model:this.model});this.views.add(e)}_.isUndefined(BP_Nouveau.activity.params.objects)&&"user"===BP_Nouveau.activity.params.object&&this.$el.find(".bp-activity-privacy__label-group").hide().find("input#group").attr("disabled",!0),!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&(!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData))?this.views.add(new bp.Views.FormTarget({model:this.model})):!1===bp.Nouveau.Activity.postForm.editActivityData||_.isUndefined(bp.Nouveau.Activity.postForm.editActivityData)||this.views.add(new bp.Views.EditActivityPostIn({model:this.model}))}}),bp.Views.PrivacyStageFooter=bp.View.extend({tagName:"div",id:"whats-new-privacy-stage-footer",className:"privacy-status-form-footer",template:bp.template("activity-post-privacy-stage-footer")}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"whats-new-content",events:{},initialize:function(){this.$el.html(t("<div></div>").prop("id","whats-new-textarea")),this.$el.append('<input type="hidden" name="id" id="bp-activity-id" value="0"/>'),this.views.set("#whats-new-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))}}),bp.Views.FormOptions=bp.View.extend({tagName:"div",id:"whats-new-options",template:bp.template("activity-post-form-options")}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new bp.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),bp.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this),this.toggleMultiMediaOptions()},attachAutocomplete:function(e){0!==bp.Nouveau.Activity.postForm.ActivityObjects.models.length&&bp.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay(),this.toggleMultiMediaOptions()},postIn:function(e){if(_.isUndefined(e.get("id"))){this.model.set("item_id",0),this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}));return}this.model.set("item_id",e.get("id")),"group"===this.model.get("object")?(this.views.remove("#whats-new-post-in-box-items"),this.views.add(new bp.Views.AutoComplete({collection:bp.Nouveau.Activity.postForm.ActivityObjects,type:this.model.get("object"),placeholder:BP_Nouveau.activity.params.objects.group.autocomplete_placeholder})),this.model.set("object",this.model.get("object")),this.model.set("group_name",e.get("name")),this.model.set("item_name",e.get("name")),this.model.set("group_image",e.get("avatar_url")),this.model.set("group_url",e.get("group_url"))):this.views.set("#whats-new-post-in-box-items",new bp.Views.Item({model:e}))},updateDisplay:function(){"user"!==this.model.get("object")?(this.$el.removeClass(),t("#activity-post-form-privacy").hide()):this.$el.hasClass("in-profile")||(this.$el.addClass("in-profile"),t("#activity-post-form-privacy").show())},toggleMultiMediaOptions:function(){_.isUndefined(BP_Nouveau.media)||("user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-media-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.group_document?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-document-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.group_video?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-video-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-media-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.profile_document?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-document-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.profile_video?(void 0===bp.Nouveau.Activity.postForm.dropzone||null===bp.Nouveau.Activity.postForm.dropzone||"activity-post-video-uploader"===bp.Nouveau.Activity.postForm.dropzone.element.id)&&(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")),t("#show-toolbar-button").removeClass("active"),t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip",t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip-show")))}}),bp.Views.EditorToolbar=bp.View.extend({tagName:"div",id:"editor-toolbar",template:bp.template("editor-toolbar"),events:{"click .post-mention":"triggerMention"},triggerMention:function(e){if(e.preventDefault(),window.activity_editor){var i=window.activity_editor.getHTML();" "===i.slice(-1)||""===i?window.activity_editor.insertText("@"):window.activity_editor.insertText(" @"),window.activity_editor.focus(),t(window.activity_editor.getEditorElements().wwEditor).trigger("keyup")}}}),bp.Views.ActivityToolbar=bp.View.extend({tagName:"div",id:"whats-new-toolbar",template:bp.template("whats-new-toolbar"),events:{"click .post-elements-buttons-item.disable .toolbar-button":"disabledButton","click #activity-link-preview-button":"toggleURLInput","click #activity-gif-button":"toggleGifSelector","click #activity-media-button":"toggleMediaSelector","click #activity-document-button":"toggleDocumentSelector","click #activity-video-button":"toggleVideoSelector","click .post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )":"activeButton","click .post-elements-buttons-item.post-gif:not(.disable)":"activeMediaButton","click .post-elements-buttons-item.post-media:not(.disable)":"activeMediaButton","click .post-elements-buttons-item.post-video:not(.disable)":"activeVideoButton","click .post-elements-buttons-item:not(.post-gif):not(.active)":"scrollToMedia"},gifMediaSearchDropdownView:!1,initialize:function(){document.addEventListener("keydown",_.bind(this.closePickersOnEsc,this)),t(document).on("click",_.bind(this.closePickersOnClick,this))},render:function(){return this.$el.html(this.template(this.model.attributes)),this.$self=this.$el.find("#activity-gif-button"),this.$gifPickerEl=this.$el.find(".gif-media-search-dropdown"),this.$emojiPickerEl=t("#whats-new"),this.$el.removeClass("hidden"),setTimeout(function(){var e=t(".activity-form #whats-new-toolbar");e&&(0===e.children(":visible").length?e.addClass("hidden"):e.removeClass("hidden"))},0),this},toggleURLInput:function(e){var t;e.preventDefault(),this.closeMediaSelector(),this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),t=new Event(this.model.get("link_scrapping")?"activity_link_preview_close":"activity_link_preview_open"),document.dispatchEvent(t)},closeURLInput:function(){var e=new Event("activity_link_preview_close");document.dispatchEvent(e)},toggleGifSelector:function(e){e.preventDefault();var i=t(e.currentTarget).closest(".post-elements-buttons-item");if(!(i.hasClass("no-click")||i.hasClass("disable"))){this.closeMediaSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),this.$gifPickerEl.is(":empty")&&(this.gifMediaSearchDropdownView=new bp.Views.GifMediaSearchDropdown({model:this.model}),this.$gifPickerEl.html(this.gifMediaSearchDropdownView.render().el));var o=t(e.currentTarget).parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container");this.$self.hasClass("open")&&o.length&&""==t.trim(o.html())?this.$self.removeClass("open"):this.$self.addClass("open"),"bp_activity_edit"!==e.type&&this.$gifPickerEl.toggleClass("open")}},closeGifSelector:function(){Backbone.trigger("activity_gif_close")},toggleMediaSelector:function(e){e.preventDefault();var i=t(e.currentTarget).closest(".post-elements-buttons-item");!t(".activity-form").hasClass("focus-in")||i.hasClass("no-click")||i.hasClass("disable")||(this.closeGifSelector(),this.closeDocumentSelector(),this.closeVideoSelector(),Backbone.trigger("activity_media_toggle"))},toggleDocumentSelector:function(e){e.preventDefault();var i=t(e.currentTarget).closest(".post-elements-buttons-item");!t(".activity-form").hasClass("focus-in")||i.hasClass("no-click")||i.hasClass("disable")||(this.closeGifSelector(),this.closeMediaSelector(),this.closeVideoSelector(),Backbone.trigger("activity_document_toggle"))},toggleVideoSelector:function(e){e.preventDefault();var i=t(e.currentTarget).closest(".post-elements-buttons-item");!t(".activity-form").hasClass("focus-in")||i.hasClass("no-click")||i.hasClass("disable")||(this.closeMediaSelector(),this.closeDocumentSelector(),this.closeGifSelector(),Backbone.trigger("activity_video_toggle"))},closeMediaSelector:function(){Backbone.trigger("activity_media_close")},closeDocumentSelector:function(){Backbone.trigger("activity_document_close")},closeVideoSelector:function(){Backbone.trigger("activity_video_close")},closePickersOnEsc:function(e){"Escape"!==e.key&&27!==e.keyCode||_.isUndefined(BP_Nouveau.media)||_.isUndefined(BP_Nouveau.media.gif_api_key)||(this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open"))},closePickersOnClick:function(e){var i=t(e.target);if(!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.gif_api_key)&&!i.closest(".post-gif").length){var o=i.parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container");o.length&&""!==t.trim(o.html())?this.$self.addClass("open"):this.$self.removeClass("open"),this.$gifPickerEl.removeClass("open")}},activeButton:function(e){t(e.currentTarget).hasClass("active")?this.$el.find(".post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )").removeClass("active"):(this.$el.find(".post-elements-buttons-item:not( .post-gif ):not( .post-media ):not( .post-video )").removeClass("active"),e.currentTarget.classList.add("active"));var i=t(e.currentTarget).parents("#whats-new-form").find("#whats-new-attachments .activity-attached-gif-container");i.length&&""==t.trim(i.html())&&this.$self.removeClass("open")},activeMediaButton:function(e){t(e.currentTarget).hasClass("active")?this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media, .post-elements-buttons-item.post-video").removeClass("active"):(this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media, .post-elements-buttons-item.post-video").removeClass("active"),e.currentTarget.classList.add("active"))},activeVideoButton:function(e){this.$el.find(".post-elements-buttons-item.post-gif, .post-elements-buttons-item.post-media").removeClass("active"),t(e.currentTarget).hasClass("active")?e.currentTarget.classList.remove("active"):e.currentTarget.classList.add("active")},disabledButton:function(){Backbone.trigger("onError",BP_Nouveau.activity.params.errors.media_fail,"info noMediaError")},scrollToMedia:function(){var e=this.$el.closest("#whats-new-form").find(".whats-new-scroll-view");e.stop().animate({scrollTop:e[0].scrollHeight},300)}}),bp.Views.ActivityAttachments=bp.View.extend({tagName:"div",id:"whats-new-attachments",activityLinkPreview:null,activityAttachedGifPreview:null,activityMedia:null,activityDocument:null,activityVideo:null,className:"empty",initialize:function(){_.isUndefined(BP_Nouveau.activity.params.link_preview)||(this.activityLinkPreview=new bp.Views.ActivityLinkPreview({model:this.model}),this.views.add(this.activityLinkPreview)),_.isUndefined(bp.Views.activityPollView)||(this.activityPollView=new bp.Views.activityPollView({model:this.model}),this.views.add(this.activityPollView)),_.isUndefined(window.Dropzone)||(this.activityMedia=new bp.Views.ActivityMedia({model:this.model}),this.views.add(this.activityMedia),this.activityDocument=new bp.Views.ActivityDocument({model:this.model}),this.views.add(this.activityDocument),this.activityVideo=new bp.Views.ActivityVideo({model:this.model}),this.views.add(this.activityVideo)),this.activityAttachedGifPreview=new bp.Views.ActivityAttachedGifPreview({model:this.model}),this.views.add(this.activityAttachedGifPreview)},onClose:function(){bp.draft_activity.data&&((void 0===bp.draft_activity.is_discard_draft_activity||!1===bp.draft_activity.is_discard_draft_activity)&&(bp.draft_activity.allow_delete_media=!1),bp.draft_activity.display_post=""),_.isNull(this.activityLinkPreview)||this.activityLinkPreview.destroy(),_.isNull(this.activityAttachedGifPreview)||this.activityAttachedGifPreview.destroy(),_.isNull(this.activityMedia)||this.activityMedia.destroy(),_.isNull(this.activityDocument)||this.activityDocument.destroyDocument(),_.isNull(this.activityVideo)||this.activityVideo.destroyVideo(),bp.draft_activity.is_discard_draft_activity=!1}}),bp.Views.FormButtons=bp.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new bp.View({tagName:"ul",id:"whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#whats-new-buttons",new bp.Views.FormButton({model:e}))},isActive:function(e){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===e.get("active")?(_.each(this.views._views["#whats-new-buttons"],function(t){t.model.get("id")!==e.get("id")&&(t.model.set("active",!1,{silent:!0}),t.$el.removeClass("active"),this.collection.trigger("reset:"+t.model.get("id"),this.model))},this),this.collection.trigger("display:"+e.get("id"),this)):this.collection.trigger("reset:"+e.get("id"),this.model)}}),bp.Views.FormButton=bp.View.extend({tagName:"li",className:"whats-new-button",template:bp.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){this.reset=new bp.Views.ActivityInput({type:"reset",id:"aw-whats-new-reset",className:"text-button small",value:BP_Nouveau.activity.strings.cancelButton});var e=BP_Nouveau.activity.strings.postUpdateButton;t("#whats-new-form").hasClass("bp-activity-edit")&&(e=BP_Nouveau.activity.strings.updatePostButton),("scheduled"===this.model.get("activity_action_type")||"scheduled"===this.model.get("activity_status"))&&(e=BP_Nouveau.activity.strings.updatePostButton),this.submit=new bp.Views.ActivityInput({model:this.model,type:"submit",id:"aw-whats-new-submit",className:"button",name:"aw-whats-new-submit",value:e}),this.views.set([this.submit,this.reset]),this.model.on("change:object",this.updateDisplay,this),this.model.on("change:posting",this.updateStatus,this),this.model.on("change:activity_action_type",this.updateSubmitLabel,this)},updateDisplay:function(e){!_.isUndefined(e)&&("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))},updateStatus:function(e){_.isUndefined(e)||(e.get("posting")?(this.submit.el.disabled=!0,this.reset.el.disabled=!0,this.submit.el.classList.add("loading")):(this.submit.el.disabled=!1,this.reset.el.disabled=!1,this.submit.el.classList.remove("loading")))},updateSubmitLabel:function(e){var i=BP_Nouveau.activity.strings.postUpdateButton;t("#whats-new-form").hasClass("bp-activity-edit")&&(i=BP_Nouveau.activity.strings.updatePostButton),"scheduled"===e.get("activity_action_type")||"scheduled"===this.model.get("activity_status")?this.submit.el.value=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.schedulePostButton:"":this.submit.el.value=i}}),bp.Views.EditActivityPostIn=bp.View.extend({template:bp.template("activity-edit-postin"),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),bp.Views.FormSubmitWrapper=bp.View.extend({tagName:"div",id:"activity-form-submit-wrapper",initialize:function(){t("#whats-new-form").addClass("focus-in").parent().addClass("modal-popup").closest("body").addClass("activity-modal-open"),t("#bp-nouveau-activity-form-placeholder").show(),_.isUndefined(bp.Views.activityPollForm)||this.views.add(new bp.Views.activityPollForm({model:this.model})),this.views.add(new bp.Views.ActivityInput({model:this.model,type:"button",id:"discard-draft-activity",className:"button outline",name:"discard-draft-activity",value:BP_Nouveau.activity.strings.discardButton})),void 0!==bp.Views.activitySchedulePost&&this.views.add(new bp.Views.activitySchedulePost({model:this.model})),this.views.add(new bp.Views.FormSubmit({model:this.model}))}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"activity-form",id:"whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #whats-new":"displayFull",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate","click #whats-new-toolbar":"triggerDisplayFull","click #discard-draft-activity":"discardDraftActivity"},initialize:function(){var e=_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"]);if(!_.isUndefined(BP_Nouveau.activity_schedule)){var i=_.pick(BP_Nouveau.activity_schedule.params,["can_schedule_in_feed"]);e=_.extend(e,i)}if(!_.isUndefined(BP_Nouveau.activity_polls)){var o=_.pick(BP_Nouveau.activity_polls.params,["can_create_poll_activity"]);e=_.extend(e,o)}this.model=new bp.Models.Activity(e),this.listenTo(Backbone,"mediaprivacy",this.updateMultiMediaOptions),this.listenTo(Backbone,"mediaprivacytoolbar",this.updateMultiMediaToolbar),this.listenTo(Backbone,"onError",this.onError),this.listenTo(Backbone,"cleanFeedBack",this.cleanFeedback),this.listenTo(Backbone,"triggerToastMessage",this.triggerToastMessage),"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.resetModel=this.model.clone(),this.formContentView=new bp.Views.FormContent({activity:this.model,model:this.model}),this.views.set([new bp.Views.ActivityHeader({model:this.model}),new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.PrivacyStage({model:this.model}),this.formContentView,new bp.Views.EditorToolbar({model:this.model}),new bp.Views.ActivityToolbar({model:this.model})]),this.model.on("change:errors",this.displayFeedback,this);var a=this;t(document).ready(function(e){t("#whats-new-form").closest("body").addClass("initial-post-form-open"),t("body").hasClass("initial-post-form-open")&&(a.displayFull(e),a.$el.closest(".activity-update-form").find("#aw-whats-new-reset").trigger("click"))})},postValidate:function(){var e="";if(window.activity_editor)e=window.activity_editor.getHTML();else{var i=this.$el.find("#whats-new");i.length&&(e=t.trim(i[0].innerHTML))}e=e.replace(/&nbsp;/g," ");var o="";if(window.activity_editor)o=t(t.parseHTML(e)).text().trim(),""===window.activity_editor.getMarkdown().trim()&&""!==window.activity_editor.getHTML()&&window.activity_editor.setHTML("");else{var a=this.$el.find("#whats-new");a.length&&""===(o=t(t.parseHTML(a[0].innerHTML)).text().trim())&&""===a[0].innerHTML.replace(/<p><br><\/p>/g,"").replace(/<br>/g,"").trim()&&(a[0].innerHTML="")}""===o&&(_.isUndefined(this.model.get("link_success"))||!0!==this.model.get("link_success"))&&(_.isUndefined(this.model.get("video"))||0===this.model.get("video").length)&&(_.isUndefined(this.model.get("document"))||0===this.model.get("document").length)&&(_.isUndefined(this.model.get("media"))||0===this.model.get("media").length)&&(_.isUndefined(this.model.get("gif_data"))||_.isEmpty(this.model.get("gif_data")))&&(_.isUndefined(this.model.get("poll"))||_.isEmpty(this.model.get("poll")))?this.$el.addClass("focus-in--empty"):this.$el.removeClass("focus-in--empty")},displayFull:function(e){if(6!==this.views._views[""].length&&t(this.views._views[""][6].$el).hasClass("updated")&&(this.cleanFeedback(),t("#whats-new-form").removeClass("bottom-notice")),6===this.views._views[""].length){"focusin"===e.type&&t("#whats-new-form").closest("body").removeClass("initial-post-form-open").addClass(e.type+"-post-form-open"),this.model.on("change:video change:document change:media change:gif_data change:privacy, change:link_success",this.postValidate,this);var i=this;if(_.each(this.views._views[""],function(e){"message-feedabck"!==e.$el.prop("id")||e.$el.hasClass("noMediaError")||(i.cleanFeedback(),i.$el.removeClass("has-feedback"))}),_.each(this.views._views[""],function(e,t){t>4&&e.close()}),this.formContentView&&this.formContentView.views){var o=this.formContentView.views.get("#whats-new-textarea");o&&o[0]&&"function"==typeof o[0].activateToastUIEditor?(console.log("PostForm.displayFull: Calling activateToastUIEditor on WhatsNew instance."),o[0].activateToastUIEditor(),console.log("PostForm.displayFull: activateToastUIEditor called. Checking window.activity_editor immediately:",window.activity_editor),setTimeout(function(){window.activity_editor&&"function"==typeof window.activity_editor.focus?(console.log("PostForm.displayFull: Focusing editor via window.activity_editor."),window.activity_editor.focus()):console.log("PostForm.displayFull: window.activity_editor not found or not focusable in setTimeout.")},50)):console.log("PostForm.displayFull: WhatsNew instance or activateToastUIEditor method not found.")}else console.log("PostForm.displayFull: formContentView or its views not found.");!0===BP_Nouveau.activity.params.backcompat&&this.views.add(new bp.Views.FormOptions({model:this.model})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(bp.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add(new bp.Views.FormButtons({collection:bp.Nouveau.Activity.postForm.buttons,model:this.model}))),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),t("body").hasClass(e.type+"-post-form-open")&&(t(".activity-update-form #whats-new-form").append('<div class="whats-new-form-footer"></div>'),t(".activity-update-form #whats-new-form").find("#whats-new-toolbar").appendTo(".whats-new-form-footer"),t(".activity-update-form #whats-new-form").find("#activity-form-submit-wrapper").appendTo(".whats-new-form-footer"),_.isUndefined(BP_Nouveau.activity_schedule)||_.isUndefined(typeof BP_Nouveau.activity_schedule.params.can_schedule_in_feed)||!0!==BP_Nouveau.activity_schedule.params.can_schedule_in_feed||t("#whats-new-form").find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),_.isUndefined(BP_Nouveau.activity_polls)||_.isUndefined(typeof BP_Nouveau.activity_polls.params.can_create_poll_activity)||!0!==BP_Nouveau.activity_polls.params.can_create_poll_activity||t("#whats-new-form").find(".bb-post-poll-button").removeClass("bp-hide")),t(".activity-update-form .whats-new-scroll-view").length?t(".activity-update-form  #whats-new-attachments").appendTo(".activity-update-form .whats-new-scroll-view"):(t(".activity-update-form .whats-new-form-header, .activity-update-form  #whats-new-attachments").wrapAll('<div class="whats-new-scroll-view"></div>'),t(".whats-new-scroll-view").on("scroll",function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||t(".atwho-container #atwho-ground-whats-new .atwho-view").hide()}),t(window).on("resize",function(){t(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),this.updateMultiMediaOptions(),null!==window.activityMediaAction&&(t(".activity-update-form.modal-popup").find("#"+window.activityMediaAction).trigger("click"),window.activityMediaAction=null),0===t(".activity-update-form .activity-update-form-overlay").length&&t(".activity-update-form.modal-popup").prepend('<div class="activity-update-form-overlay"></div>'),this.activityHideModalEvent(),t("body").hasClass(e.type+"-post-form-open")&&!t("#whats-new-form").hasClass("bp-activity-edit")&&(bp.draft_local_interval||(bp.draft_local_interval=setInterval(function(){bp.Nouveau.Activity.postForm.storeDraftActivity()},3e3)),bp.draft_ajax_interval||(bp.draft_ajax_interval=setInterval(function(){bp.Nouveau.Activity.postForm.postDraftActivity(!1,!1)},2e4)),bp.Nouveau.Activity.postForm.displayDraftActivity()),t("a.bp-suggestions-mention:empty").remove()}},activityHideModalEvent:function(){t(document).on("keyup",function(e){27===e.keyCode&&!1===e.ctrlKey&&setTimeout(function(){t(".activity-update-form.modal-popup #whats-new").blur(),t(".activity-update-form.modal-popup #aw-whats-new-reset").trigger("click");var e=t("#bp-nouveau-single-activity-edit-form-wrap");e.length&&e.hide()},0)})},triggerDisplayFull:function(e){if(e.preventDefault(),(t(e.target).hasClass("toolbar-button")||t(e.target).parent().hasClass("toolbar-button"))&&(window.activityMediaAction=t(e.target).parent().attr("id"),void 0===window.activityMediaAction&&(window.activityMediaAction=t(e.target).attr("id"))),!this.$el.hasClass("focus-in"))if(window.activity_editor)window.activity_editor.focus();else{var i=this.$el.find("#whats-new")[0];if(i){var o=window.getSelection(),a=document.createRange();a.setStart(i,0),a.setEnd(i,0),o.removeAllRanges(),o.addRange(a)}}},resetForm:function(){_.each(this.views._views[""],function(e,t){t>4&&e.close()}),window.activity_editor?window.activity_editor.setHTML(""):t("#whats-new").html(""),t("#whats-new-form").removeClass("focus-in focus-in--privacy focus-in--group focus-in--scroll has-draft").parent().removeClass("modal-popup").closest("body").removeClass("activity-modal-open"),t("#bp-nouveau-activity-form-placeholder").hide(),t("#whats-new-content").find("#bp-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bp-activity-edit hide-schedule-button"),_.isUndefined(BP_Nouveau.activity.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bp-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes);var e=t("#whats-new-form");e.find("#public.bp-activity-privacy__input").prop("checked",!0),e.find("#bp-activity-group-ac-items .bp-activity-object").removeClass("selected"),e.find("#bp-activity-group-ac-items .bp-activity-object__radio").prop("checked",!1),t("#show-toolbar-button").removeClass("active"),t(".medium-editor-toolbar-actions").show(),t(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip",t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),t("#whats-new").removeData("activity-url-preview"),this.$el.find(".whats-new-form-footer").remove(),this.updateMultiMediaOptions()},cleanFeedback:function(){_.each(this.views._views[""],function(e){"message-feedabck"===e.$el.prop("id")&&(e.remove(),t("#whats-new-form #activity-header").css({"margin-bottom":0}))})},triggerToastMessage:function(e,i,o,a,s){t(document).trigger("bb_trigger_toast_message",[e,i,o,a,s])},displayFeedback:function(e){if(_.isUndefined(this.model.get("errors")))this.cleanFeedback(),this.$el.removeClass("has-feedback");else{this.cleanFeedback(),this.views.add(new bp.Views.activityFeedback(e.get("errors"))),this.$el.addClass("has-feedback");var t=this.$el.find("#message-feedabck").outerHeight(!0);this.$el.find("#activity-header").css({"margin-bottom":t+"px"})}},decodeHtml:function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},postUpdate:function(e){var i=this,o={},a=!1;if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}i.model.unset("errors"),_.each(i.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),e.name.startsWith("bb-poll-question-option[")&&(e.name=e.name.replace(/\[\d+\]/,"")),-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in","bb-schedule-activity-date-field","bb-schedule-activity-meridian","bb-schedule-activity-time-field","bb-poll-question-field","bb-poll-duration","bb-poll-question-option","bb-poll-allow-multiple-answer","bb-poll-allow-new-option"],e.name)&&(_.isUndefined(o[e.name])?o[e.name]=e.value:(_.isArray(o[e.name])||(o[e.name]=[o[e.name]]),o[e.name].push(e.value)))});var s="";if(window.activity_editor)s=window.activity_editor.getHTML();else if(window.activity_edit_editor)s=window.activity_edit_editor.getHTML();else{var d=i.$el.find("#whats-new");d.length&&(s=t.trim(d[0].innerHTML))}s=s.replace(/&nbsp;/g," "),i.model.set("content",s,{silent:!0}),i.model.set(o,{silent:!0});var n=i.model.get("media");if("group"==i.model.get("object")&&!_.isUndefined(n)&&n.length){for(var l=0;l<n.length;l++)n[l].group_id=i.model.get("item_id");i.model.set("media",n)}var r=i.model.get("document");if("group"==i.model.get("object")&&!_.isUndefined(r)&&r.length){for(var c=0;c<r.length;c++)r[c].group_id=i.model.get("item_id");i.model.set("document",r)}var p=i.model.get("video");if("group"==i.model.get("object")&&!_.isUndefined(p)&&p.length){for(var u=0;u<p.length;u++)p[u].group_id=i.model.get("item_id");i.model.set("video",p)}if(""===t(t.parseHTML(s)).text().trim()&&!_.isUndefined(this.model.get("link_success"))&&!0!==this.model.get("link_success")&&!_.isUndefined(i.model.get("video"))&&!i.model.get("video").length&&!_.isUndefined(i.model.get("document"))&&!i.model.get("document").length&&!_.isUndefined(i.model.get("media"))&&!i.model.get("media").length&&!_.isUndefined(i.model.get("gif_data"))&&!Object.keys(i.model.get("gif_data")).length&&!_.isUndefined(i.model.get("poll"))&&!Object.keys(i.model.get("poll")).length)return i.model.set("errors",{type:"error",value:BP_Nouveau.activity.params.errors.empty_post_update}),!1;i.model.set("posting",!0);var v={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce};if(t("#_bp_as_nonce").val()&&(v._bp_as_nonce=t("#_bp_as_nonce").val()),v=_.omit(_.extend(v,this.model.attributes),["link_images","link_image_index","link_image_index_save","link_success","link_error","link_error_msg","link_scrapping","link_loading","posting","group_image","can_schedule_in_feed","can_create_poll_activity","bb-poll-question-option","poll"]),i.model.get("link_success")){var m=i.model.get("link_images"),h=i.model.get("link_image_index"),f=i.model.get("link_image_index_save");m&&m.length&&(v=_.extend(v,{link_image:m[f],link_image_index:h,link_image_index_save:f}))}else v=_.omit(v,["link_title","link_description","link_url"]);i.model.get("id")>0&&(a=!0,v.edit=1,bp.privacyEditable||(v.privacy=bp.privacy)),_.isUndefined(v.link_description)||_.isUndefined(v.link_embed)||!0!==v.link_embed||(v.link_description=""),bp.ajax.post("post_update",v).done(function(e){i.model.get("id")>0&&t("html, body").animate({scrollTop:t(window).scrollTop()+1}),bp.Nouveau.Activity.postForm.postActivityEditHideModal();var o=bp.Nouveau.getStorage("bp-activity"),s=t('[data-bp-search="activity"] input[type="search"]').val(),d={},n=!1;s&&(s=RegExp(s,"im"),d=e.activity.match(s)),(!s||d)&&(n=!o.filter||0===parseInt(o.filter,10)||"activity_update"===o.filter),n&&e.is_directory&&(n="all"===o.scope&&("user"===i.model.get("object")||"group"===i.model.get("object"))||i.model.get("object")+"s"===o.scope),""===e.activity&&e.is_user_activity&&(n=!1);var l=i.model.get("media");if(!_.isUndefined(l)&&l.length){for(var c=0;c<l.length;c++)l[c].saved=!0;i.model.set("media",l)}var p=!1;!0==i.model.get("link_embed")&&(p=!0);var u=i.model.get("document");if(!_.isUndefined(u)&&u.length){for(var m=0;m<u.length;m++)u[m].saved=!0;i.model.set("document",u)}var h=i.model.get("video");if(!_.isUndefined(h)&&h.length){for(var f=0;f<h.length;f++)h[f].saved=!0;i.model.set("video",h)}if((""===i.model.get("id")||0===parseInt(i.model.get("id")))&&bp.Nouveau.Activity.postForm.resetDraftActivity(!1),i.resetForm(),"scheduled"===v.activity_action_type){var b=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditSuccessScheduleTitle:"",y=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditSuccessScheduleDesc:"",w=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.EditViewSchedulePost:"";if(v.edit_activity||(b=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.successScheduleTitle:"",y=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.successScheduleDesc:"",w=void 0!==BP_Nouveau.activity_schedule?BP_Nouveau.activity_schedule.strings.viewSchedulePosts:""),""!==b&&""!==y&&""!==w){var g="";_.isUndefined(v.privacy)||"group"!==v.privacy||_.isUndefined(v.group_url)||(g=v.group_url+"?action=scheduled_posts"),Backbone.trigger("triggerToastMessage",b,"<div>"+y+' <span class="toast-messages-action_link bb-view-scheduled-posts"> '+w+"</span></div>","success",g,!0)}}var C=t(".bb-subnav-filters-filtering .subnav-filters-modal ul li.selected").data("bp-scope");if(e.is_user_activity&&""!==e.activity&&(n="just-me"===C),n)if(a&&"scheduled"!==v.activity_action_type&&t("#activity-"+e.id).length){t("#activity-"+e.id).replaceWith(e.activity);var N=e.activity.indexOf('data-bp-activity="')+18,k=e.activity.indexOf('"',N),P=e.activity.substring(N,k),B=JSON.parse(i.decodeHtml(P)),F=t("<div>").html(B.content).html();B.content=F;var A=t("#activity-modal .activity-list .activity-item"),z=A.find(".activity-content").find(".activity-inner"),U=A.find(".bb-media-privacy-wrap").find(".privacy-wrap").find(".privacy"),x=A.find(".bb-media-privacy-wrap").find(".activity-privacy li");if(A.length>0){var V=t("#activity-"+e.id).find(".activity-content").find(".activity-inner").html();z.empty(),z.append(V),A.data("bp-activity",B),U.removeClass().addClass("privacy selected "+B.privacy),x.removeClass("selected"),x.filter(function(){return t(this).hasClass(B.privacy)}).addClass("selected")}}else!t("#activity-"+e.id).length&&(t("#activity-stream ul.activity-list").length||t("#activity-stream").html(t("<ul></ul>").addClass("activity-list item-list bp-list")),t("#activity-stream ul.activity-list li:first.bb-pinned").length>0?bp.Nouveau.inject("#activity-stream ul.activity-list li:first.bb-pinned",e.activity,"after"):bp.Nouveau.inject("#activity-stream ul.activity-list",e.activity,"prepend"),jQuery(window).scroll(),p&&(_.isUndefined(window.instgrm)||window.instgrm.Embeds.process(),_.isUndefined(window.FB)||_.isUndefined(window.FB.XFBML)||window.FB.XFBML.parse(t(r).find("#activity-"+e.id).get(0))));else i.views.add(new bp.Views.activityFeedback({value:e.message,type:"updated"})),t("#whats-new-form").addClass("bottom-notice");navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&t("input").focus().blur()}).fail(function(e){i.model.set("posting",!1),i.model.set("errors",{type:"error",value:void 0===e.message?BP_Nouveau.activity.params.errors.post_fail:e.message})})},updateMultiMediaOptions:function(){_.isUndefined(BP_Nouveau.media)||("user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.group_document?(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.group_video?(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),Backbone.trigger("activity_media_close")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.profile_document?(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),Backbone.trigger("activity_document_close")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.profile_video?(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),Backbone.trigger("activity_video_close")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")),t(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))},updateMultiMediaToolbar:function(){_.isUndefined(BP_Nouveau.media)||("user"!==this.model.get("object")?(!1===BP_Nouveau.media.group_media?(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),t("#whats-new-attachments .dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.group_document?(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),t("#whats-new-attachments .dropzone.document-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.group_video?(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),t("#whats-new-attachments .dropzone.video-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifGroup=new bp.Views.PostGifGroup({model:this.model}),!1===BP_Nouveau.media.emoji.groups?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")):(!1===BP_Nouveau.media.profile_media?(t("#whats-new-toolbar .post-media.media-support").removeClass("active").addClass("media-support-hide"),t("#whats-new-attachments .dropzone.media-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-media.media-support").removeClass("media-support-hide"),!1===BP_Nouveau.media.profile_document?(t("#whats-new-toolbar .post-media.document-support").removeClass("active").addClass("document-support-hide"),t("#whats-new-attachments .dropzone.document-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-media.document-support").removeClass("document-support-hide"),!1===BP_Nouveau.video.profile_video?(t("#whats-new-toolbar .post-video.video-support").removeClass("active").addClass("video-support-hide"),t("#whats-new-attachments .dropzone.video-dropzone").removeClass("open dz-clickable").addClass("closed")):t("#whats-new-toolbar .post-video.video-support").removeClass("video-support-hide"),bp.Nouveau.Activity.postForm.postGifProfile=new bp.Views.PostGifProfile({model:this.model}),!1===BP_Nouveau.media.emoji.profile?t("#editor-toolbar .post-emoji").addClass("post-emoji-hide"):t("#editor-toolbar .post-emoji").removeClass("post-emoji-hide")),t(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"))},onError:function(e,t){this.model.unset("errors"),this.model.set("errors",{type:t||"error",value:e})},discardDraftActivity:function(){bp.draft_activity.is_discard_draft_activity=!0,_.each(this.views._views[""],function(e,t){t>4&&e.close()}),t("#whats-new").css({resize:"none",height:"50px"}),t("#bp-nouveau-activity-form-placeholder").hide(),t("#whats-new-content").find("#bp-activity-id").val(""),bp.Nouveau.Activity.postForm.postForm.$el.removeClass("bp-activity-edit"),_.isUndefined(BP_Nouveau.activity.params.objects)||bp.Nouveau.Activity.postForm.postForm.$el.find(".bp-activity-privacy__label-group").show().find("input#group").attr("disabled",!1),this.model.set("edit_activity",!1),bp.Nouveau.Activity.postForm.editActivityData=!1,"user"===BP_Nouveau.activity.params.object&&(BP_Nouveau.activity.params.access_control_settings.can_create_activity?this.$el.removeClass("bp-hide"):this.$el.addClass("bp-hide")),this.model.clear(),this.model.set(this.resetModel.attributes),this.$el.find(".whats-new-form-footer").remove();var e=t("#whats-new-form");e.find("#public.bp-activity-privacy__input").prop("checked",!0),e.find("#bp-activity-group-ac-items .bp-activity-object__radio").prop("checked",!1).removeAttr("checked"),e.find("#bp-activity-group-ac-items .bb-radio-style.selected").removeClass("selected"),t(".medium-editor-toolbar").removeClass("active medium-editor-toolbar-active"),t("#show-toolbar-button").removeClass("active"),t("medium-editor-action").removeClass("medium-editor-button-active"),t(".medium-editor-toolbar-actions").show(),t(".medium-editor-toolbar-form").removeClass("medium-editor-toolbar-form-active"),t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip",t("#show-toolbar-button").parent(".show-toolbar").attr("data-bp-tooltip-show")),bp.Nouveau.Activity.postForm.activityAttachments=new bp.Views.ActivityAttachments({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityAttachments),bp.Nouveau.Activity.postForm.activityToolbar=new bp.Views.ActivityToolbar({model:this.model}),this.views.add(bp.Nouveau.Activity.postForm.activityToolbar),this.views.add(new bp.Views.FormSubmitWrapper({model:this.model})),t("body").hasClass("focusin-post-form-open")&&(t(".activity-update-form #whats-new-form").append('<div class="whats-new-form-footer"></div>'),t(".activity-update-form #whats-new-form").find("#whats-new-toolbar").appendTo(".whats-new-form-footer"),t(".activity-update-form #whats-new-form").find("#activity-form-submit-wrapper").appendTo(".whats-new-form-footer")),t(".activity-update-form .whats-new-scroll-view").length?t(".activity-update-form  #whats-new-attachments").appendTo(".activity-update-form .whats-new-scroll-view"):(t(".activity-update-form .whats-new-form-header, .activity-update-form  #whats-new-attachments").wrapAll('<div class="whats-new-scroll-view"></div>'),t(".whats-new-scroll-view").on("scroll",function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||t(".atwho-container #atwho-ground-whats-new .atwho-view").hide()}),t(window).on("resize",function(){t(".atwho-container #atwho-ground-whats-new .atwho-view:visible").hide()})),this.updateMultiMediaOptions(),bp.Nouveau.Activity.postForm.resetDraftActivity(!0)}}),bp.Views.PostFormPlaceholder=bp.View.extend({tagName:"form",className:"activity-form-placeholder",id:"whats-new-form-placeholder",initialize:function(){this.model=new bp.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.views.set([new bp.Views.UserStatusHuddle({model:this.model}),new bp.Views.FormPlaceholderContent({activity:this.model,model:this.model}),new bp.Views.ActivityToolbar({model:this.model})])}}),bp.Views.FormPlaceholderContent=bp.View.extend({tagName:"div",id:"whats-new-content-placeholder",initialize:function(){this.$el.html(t("<div></div>").prop("id","whats-new-textarea-placeholder")),this.views.set("#whats-new-textarea-placeholder",new bp.Views.WhatsNewPlaceholder)}}),bp.Views.WhatsNewPlaceholder=bp.View.extend({tagName:"div",className:"bp-suggestions-placehoder",id:"whats-new-placeholder",attributes:{name:"whats-new-placeholder",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel,contenteditable:!0}}),bp.Views.PostGifProfile=bp.View.extend({initialize:function(){(_.isUndefined(BP_Nouveau.media.gif.profile)||!1!==BP_Nouveau.media.gif.profile)&&""!==BP_Nouveau.media.gif_api_key?t("#whats-new-toolbar .post-gif").removeClass("post-gif-hide"):t("#whats-new-toolbar .post-gif").removeClass("active").addClass("post-gif-hide")}}),bp.Views.PostGifGroup=bp.View.extend({initialize:function(){(_.isUndefined(BP_Nouveau.media.gif.groups)||!1!==BP_Nouveau.media.gif.groups)&&""!==BP_Nouveau.media.gif_api_key?t("#whats-new-toolbar .post-gif").removeClass("post-gif-hide"):t("#whats-new-toolbar .post-gif").removeClass("active").addClass("post-gif-hide")}}),bp.Nouveau.Activity.postForm.start())}(bp,jQuery);
//# sourceMappingURL=buddypress-activity-post-form.js.map
